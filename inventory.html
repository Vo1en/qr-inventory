<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>çµ‚æ¥µåº«å­˜ç³»çµ± V3.1</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <!-- QR Code ç›¸é—œ -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --card: #ffffff;
            --nav-height: 68px;
            --header-height: 60px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #cbd5e1;
            margin: 0;
            padding: 0;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        .app-wrapper {
            width: 100%;
            max-width: 480px;
            background-color: #f8fafc;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.15);
        }

        /* Header */
        header {
            flex: 0 0 var(--header-height);
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            margin: 0;
            font-size: 1.05rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        header h1 span.logo {
            font-size: 1.1rem;
        }

        .status-dot {
            width: 9px;
            height: 9px;
            border-radius: 999px;
            background: #9ca3af;
            box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .status-dot.online {
            background: #4ade80;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.9);
        }

        /* Main å…§å®¹å€ */
        main {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px;
            padding-bottom: 16px;
            position: relative;
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        /* åº•éƒ¨å°è¦½åˆ— */
        nav {
            flex: 0 0 var(--nav-height);
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 20;
        }

        .nav-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 0.78rem;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px 2px;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .nav-btn .nav-icon {
            font-size: 1.35rem;
            margin-bottom: 3px;
        }

        .nav-btn.active {
            color: var(--primary);
        }

        .nav-btn.active .nav-icon {
            transform: translateY(-1px);
        }

        /* ç›¸æ©Ÿå€å¡Š */
        #camera-wrapper {
            position: relative;
            border-radius: 14px;
            overflow: hidden;
            background: #000;
            height: 260px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #reader {
            width: 100%;
            height: 100%;
        }

        #reader video {
            object-fit: cover;
            width: 100% !important;
            height: 100% !important;
            border-radius: 14px;
        }

        /* è¼¸å…¥ / æ•¸é‡å€å¡Š */
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 11px 10px;
            text-align: center;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            margin: 6px 0;
            background: #f8fafc;
        }

        input[readonly] {
            background: #e5e7eb;
        }

        .current-stock {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
        }

        .info-row-label {
            font-size: 0.88rem;
            color: #64748b;
        }

        .action-area {
            background: #f1f5f9;
            padding: 13px;
            border-radius: 12px;
            margin-top: 10px;
        }

        .btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn {
            padding: 13px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.15);
        }

        .btn span.sub {
            font-size: 0.75rem;
            font-weight: 500;
            opacity: 0.9;
        }

        .btn-in {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn-out {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn-fill {
            background: #60a5fa;
            color: white;
            padding: 8px 10px;
            font-size: 0.8rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }

        .qty-input-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 4px;
        }

        .qty-input-row input {
            flex: 1;
            margin: 0;
        }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 11px 4px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-main {
            flex: 1;
            min-width: 0;
        }

        .list-title {
            font-weight: 600;
            font-size: 0.92rem;
            color: #0f172a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .list-sub {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 2px;
        }

        .list-qty {
            font-size: 1.1rem;
            font-weight: 700;
            min-width: 42px;
            text-align: right;
        }

        /* æœå°‹ + åŒ¯å‡º */
        .sticky-search {
            position: sticky;
            top: 0;
            z-index: 5;
            background: #f8fafc;
            padding-bottom: 6px;
            margin-bottom: 6px;
        }

        .search-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #search-input {
            flex: 1;
            margin: 0;
            text-align: left;
            font-size: 0.9rem;
            padding-left: 12px;
        }

        .btn-export {
            border-radius: 10px;
            border: none;
            padding: 9px 10px;
            font-size: 0.8rem;
            font-weight: 600;
            background: #0f172a;
            color: #e5e7eb;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-export span.icon {
            font-size: 1rem;
        }

        /* è£½ç¢¼é é¢ */
        .create-card {
            padding: 22px 14px 26px;
            text-align: center;
        }

        .create-card h3 {
            font-size: 1.1rem;
            margin-top: 0;
            margin-bottom: 18px;
            color: var(--primary);
        }

        .create-card input {
            margin-bottom: 10px;
        }

        .btn-gen {
            width: 100%;
            margin-top: 4px;
            background: linear-gradient(135deg, #6366f1, #2563eb);
        }

        .qrcode-container-wrapper {
            display: flex;
            justify-content: center;
            margin-top: 18px;
        }

        .qrcode-display {
            background: #ffffff;
            padding: 14px;
            border-radius: 12px;
            border: 2px dashed #e2e8f0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            display: inline-block;
            min-width: 150px;
            min-height: 150px;
        }

        .qrcode-display p {
            margin: 0;
            font-size: 0.86rem;
            color: #94a3b8;
            text-align: center;
        }

        /* è©³ç´°è¦–çª— (åº•éƒ¨æ»‘å‡º) */
        #detail-modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: flex-end;
        }

        #detail-modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg);
            width: 100%;
            max-width: 480px;
            height: 90%;
            border-radius: 20px 20px 0 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(100%);
            transition: transform 0.25s ease-out;
        }

        #detail-modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.02rem;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.6rem;
            line-height: 1;
            cursor: pointer;
            color: #64748b;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 10px 10px 16px;
        }

        .detail-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .detail-label {
            font-size: 0.78rem;
            color: #94a3b8;
            margin-bottom: 2px;
        }

        .detail-value {
            font-size: 0.9rem;
            font-weight: 500;
            color: #1f2933;
            word-break: break-all;
        }

        .history-list {
            list-style: none;
            margin: 0;
            padding: 0;
            max-height: 260px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.8rem;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-time {
            color: #64748b;
            margin-right: 8px;
        }

        /* å°æé†’æ–‡å­— */
        .helper-text {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 2px;
        }

        @media (max-height: 650px) {
            #camera-wrapper {
                height: 220px;
            }
        }
    </style>
</head>
<body>
<div class="app-wrapper">

    <!-- Header -->
    <header>
        <h1>
            <span class="logo">ğŸ“¦</span>
            çµ‚æ¥µåº«å­˜ç³»çµ±
        </h1>
        <div id="status-light" class="status-dot" title="é€£ç·šç‹€æ…‹"></div>
    </header>

    <!-- Main Content -->
    <main id="main-content-scroll">

        <!-- 1. æƒæé é¢ -->
        <section id="view-scan">
            <div class="card" style="padding:0; margin-bottom: 10px;">
                <div id="camera-wrapper">
                    <div id="reader"></div>
                </div>
            </div>

            <div id="scan-result" class="card">
                <div id="res-id"
                     style="text-align:center; color:#94a3b8; font-family:monospace; margin-bottom:6px;">è«‹å…ˆæƒæ QR
                </div>

                <input type="text" id="res-name" placeholder="è¼¸å…¥æˆ–ä¿®æ”¹å•†å“åç¨±" onchange="updateInfo()">

                <div class="info-row">
                    <div class="info-row-label">ç›®å‰åº«å­˜</div>
                    <div class="current-stock" id="res-qty">0</div>
                </div>

                <div class="action-area">
                    <div style="font-size:0.82rem; color:#64748b; margin-bottom:3px;">ç•°å‹•æ•¸é‡ï¼š</div>
                    <div class="qty-input-row">
                        <input type="number" id="op-amount" class="qty-input" value="1" min="1" inputmode="numeric">
                        <button type="button" class="btn-fill" onclick="fillMaxStock()">å¡«å…¥åº«å­˜</button>
                    </div>
                    <p class="helper-text">æç¤ºï¼šå‡ºåº«æ™‚å¯å…ˆæŒ‰ã€Œå¡«å…¥åº«å­˜ã€ï¼Œç­‰æ–¼ä¸€æ¬¡å…¨æ•¸å‡ºè²¨ã€‚</p>

                    <div class="btn-row" style="margin-top:12px;">
                        <button class="btn btn-in" type="button" onclick="handleStock(1)">
                            å…¥åº«
                            <span class="sub">ï¼‹ åº«å­˜å¢åŠ </span>
                        </button>
                        <button class="btn btn-out" type="button" onclick="handleStock(-1)">
                            å‡ºåº«
                            <span class="sub">ï¼ åº«å­˜æ¸›å°‘</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. åº«å­˜åˆ—è¡¨é é¢ -->
        <section id="view-list" style="display:none;">
            <div class="sticky-search">
                <div class="search-row">
                    <input type="text" id="search-input" placeholder="ğŸ” ä¾åç¨±æˆ–æ–™è™Ÿæœå°‹..."
                           onkeyup="filterList()">
                    <button class="btn-export" type="button" onclick="exportToExcel()">
                        <span class="icon">ğŸ“¥</span> åŒ¯å‡º
                    </button>
                </div>
            </div>

            <div class="card" id="list-container">
                <div style="text-align:center; padding:20px; color:#94a3b8;">è¼‰å…¥ä¸­...</div>
            </div>
        </section>

        <!-- 3. ç´€éŒ„é é¢ -->
        <section id="view-logs" style="display:none;">
            <div class="card">
                <h3 style="margin-top:0; font-size:1.02rem;">ğŸ“ è¿‘æœŸç•°å‹•ç´€éŒ„</h3>
                <div id="logs-container">
                    <div style="text-align:center; padding:20px; color:#94a3b8;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </section>

        <!-- 4. è£½ç¢¼é é¢ -->
        <section id="view-create" style="display:none;">
            <div class="card create-card">
                <h3>ğŸ·ï¸ æ¨™ç±¤è£½ä½œèˆ‡åˆ—å°</h3>
                <input type="text" id="new-code" placeholder="è«‹è¼¸å…¥å•†å“ç·¨è™Ÿ (SKU)">
                <button class="btn btn-gen" type="button" onclick="makeQR()">ç”Ÿæˆ QR Code</button>
                <div class="qrcode-container-wrapper">
                    <div class="qrcode-display" id="qrcode">
                        <p>è¼¸å…¥ç·¨è™Ÿä¸¦æŒ‰ä¸‹ã€Œç”Ÿæˆã€ï¼Œå³å¯åœ¨æ­¤åˆ—å°æ¨™ç±¤</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Nav -->
    <nav>
        <button class="nav-btn active" type="button" data-view="scan">
            <span class="nav-icon">ğŸ“·</span>
            æƒæ
        </button>
        <button class="nav-btn" type="button" data-view="list">
            <span class="nav-icon">ğŸ“¦</span>
            åº«å­˜
        </button>
        <button class="nav-btn" type="button" data-view="logs">
            <span class="nav-icon">ğŸ“</span>
            ç´€éŒ„
        </button>
        <button class="nav-btn" type="button" data-view="create">
            <span class="nav-icon">ğŸ·ï¸</span>
            è£½ç¢¼
        </button>
    </nav>
</div>

<!-- è©³ç´°å½ˆçª— -->
<div id="detail-modal" onclick="if (event.target.id === 'detail-modal') closeDetail()">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">å•†å“è©³æƒ…</h2>
            <button class="modal-close-btn" type="button" onclick="closeDetail()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="card" style="margin-bottom:10px;">
                <h3 style="margin-top:0; font-size:0.98rem;">åŸºæœ¬è³‡è¨Š</h3>
                <div class="detail-info-grid">
                    <div>
                        <div class="detail-label">æ–™è™Ÿ (ID)</div>
                        <div class="detail-value" id="detail-id">---</div>
                    </div>
                    <div>
                        <div class="detail-label">æœ€å¾Œå…¥åº«æ—¥</div>
                        <div class="detail-value" id="detail-inbound-date">---</div>
                    </div>
                </div>

                <div style="margin-bottom:10px;">
                    <div class="detail-label">å“å</div>
                    <input type="text" id="detail-name" onchange="updateDetailInfo('name')">
                </div>

                <div style="margin-bottom:10px;">
                    <div class="detail-label">å­˜æ”¾ä½ç½®</div>
                    <input type="text" id="detail-location" placeholder="ä¾‹å¦‚ï¼šAæ¶-3å±¤"
                           onchange="updateDetailInfo('location')">
                </div>

                <h3 style="margin-top:4px; border-top:1px solid #e5e7eb; padding-top:8px; font-size:0.98rem;">
                    åº«å­˜ç·¨è¼¯
                </h3>
                <div style="margin-bottom:8px;">
                    <div class="detail-label">æ‰‹å‹•èª¿æ•´è‡³æ­¤æ•¸é‡</div>
                    <input type="number" id="detail-qty-input" class="qty-input" min="0">
                </div>
                <button class="btn btn-in" style="width:100%;" type="button" onclick="updateDetailQty()">æ‰‹å‹•èª¿æ•´ä¸¦å„²å­˜
                </button>
                <p class="helper-text">æœƒè‡ªå‹•ç´€éŒ„ä¸€ç­†ã€Œæ‰‹å‹•å…¥åº« / æ‰‹å‹•å‡ºåº«ã€ç•°å‹•ã€‚</p>
            </div>

            <div class="card">
                <h3 style="margin-top:0; font-size:0.98rem;">ğŸšš é€²å‡ºè²¨æ­·å²ç´€éŒ„</h3>
                <ul class="history-list" id="detail-history-list">
                    <li style="text-align:center; color:#94a3b8; padding:16px;">è¼‰å…¥ä¸­...</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    // Firebase åˆå§‹åŒ–
    const firebaseConfig = {
        apiKey: "AIzaSyAUgk7DGfnCCt1-cTAhvD2Se4YZQEoXUE8",
        authDomain: "qr-inventory-2e995.firebaseapp.com",
        projectId: "qr-inventory-2e995",
        storageBucket: "qr-inventory-2e995.firebasestorage.app",
        messagingSenderId: "1041449207118",
        appId: "1:1041449207118:web:d8c66fa15024471f0d0a1f",
        measurementId: "G-YGQYMSS6E3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const ServerTimestamp = firebase.firestore.FieldValue.serverTimestamp();

    let html5QrCode = null;
    let currentId = null;
    let isProcessing = false;
    let allData = [];

    function vibrate(pattern) {
        if (navigator.vibrate) navigator.vibrate(pattern);
    }

    // ç·šä¸Šç‹€æ…‹ç‡ˆ
    function updateStatusDot(isOnline) {
        const dot = document.getElementById('status-light');
        if (!dot) return;
        dot.classList.toggle('online', !!isOnline);
        dot.title = isOnline ? 'ç·šä¸Š - å·²é€£ç·š' : 'é›¢ç·š - ç„¡ç¶²è·¯';
    }

    // ç›¸æ©Ÿæ§åˆ¶
    async function startCamera() {
        try {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }
            await html5QrCode.start(
                {facingMode: "environment"},
                {fps: 10, qrbox: {width: 250, height: 250}, aspectRatio: 1.0},
                (text) => {
                    if (currentId === text) return;
                    vibrate([50]);
                    currentId = text;
                    fetchData(text);
                },
                (errorMessage) => {
                    // å¿½ç•¥æƒä¸åˆ°çš„éŒ¯èª¤
                }
            );
        } catch (err) {
            console.log("Camera Error:", err);
        }
    }

    async function stopCamera() {
        try {
            if (html5QrCode && html5QrCode._isScanning) {
                await html5QrCode.stop();
            }
        } catch (err) {
            console.log("Stop Camera Error:", err);
        }
    }

    // æƒæåˆ°è³‡æ–™å¾Œæ›´æ–°ç•«é¢
    function fetchData(id) {
        document.getElementById('scan-result').style.display = 'block';
        document.getElementById('res-id').innerText = id || '---';
        document.getElementById('op-amount').value = 1;

        db.collection("inventory").doc(id).onSnapshot(doc => {
            if (doc.exists) {
                const d = doc.data();
                document.getElementById('res-qty').innerText = d.qty ?? 0;
                document.getElementById('res-name').value = d.name || "";
                document.getElementById('res-name').placeholder = "è¼¸å…¥æˆ–ä¿®æ”¹å•†å“åç¨±";
            } else {
                document.getElementById('res-qty').innerText = 0;
                document.getElementById('res-name').value = "";
                document.getElementById('res-name').placeholder = "æ–°å•†å“ - è«‹è¼¸å…¥åç¨±";
            }
        });
    }

    // å…¥åº« / å‡ºåº«
    function handleStock(direction) {
        if (!currentId || isProcessing) return;
        const amount = parseInt(document.getElementById('op-amount').value, 10);
        if (isNaN(amount) || amount <= 0) {
            alert("è«‹è¼¸å…¥æ­£ç¢ºçš„ç•°å‹•æ•¸é‡");
            return;
        }

        vibrate([30]);
        isProcessing = true;
        const change = amount * direction;
        const docRef = db.collection("inventory").doc(currentId);
        const batch = db.batch();
        const name = document.getElementById('res-name').value || "æœªå‘½å";

        docRef.get().then(doc => {
            const updateFields = {
                name: name,
                updatedAt: ServerTimestamp
            };
            if (direction > 0) {
                updateFields.lastInboundDate = ServerTimestamp;
            }

            if (!doc.exists) {
                batch.set(docRef, {
                    id: currentId,
                    qty: change > 0 ? change : 0,
                    ...updateFields
                });
            } else {
                batch.update(docRef, {
                    qty: firebase.firestore.FieldValue.increment(change),
                    ...updateFields
                });
            }

            const logRef = db.collection("logs").doc();
            batch.set(logRef, {
                productId: currentId,
                productName: name,
                action: direction > 0 ? "å…¥åº«" : "å‡ºåº«",
                amount: amount,
                timestamp: ServerTimestamp
            });

            return batch.commit();
        }).then(() => {
            vibrate([50, 50]);
            document.getElementById('op-amount').value = 1;
        }).catch(err => {
            alert("äº¤æ˜“å¤±æ•—: " + err.message);
        }).finally(() => {
            isProcessing = false;
        });
    }

    // æ›´æ–°åç¨±
    function updateInfo() {
        if (!currentId) return;
        db.collection("inventory").doc(currentId).set({
            name: document.getElementById('res-name').value || "æœªå‘½å",
            id: currentId,
            updatedAt: ServerTimestamp
        }, {merge: true});
    }

    // å¡«å…¥åº«å­˜æŒ‰éˆ•
    function fillMaxStock() {
        const currentQty = parseInt(document.getElementById('res-qty').innerText || "0", 10);
        document.getElementById('op-amount').value = currentQty || 0;
        vibrate([50]);
    }

    // åº«å­˜åˆ—è¡¨ç›£è½
    db.collection("inventory").onSnapshot(snap => {
        allData = [];
        snap.forEach(doc => allData.push({...doc.data(), id: doc.id}));
        renderList(allData);
    });

    function formatDateField(field) {
        if (field && typeof field.toDate === 'function') {
            return field.toDate().toLocaleDateString();
        }
        return 'ç„¡ç´€éŒ„';
    }

    // æ¸²æŸ“åº«å­˜åˆ—è¡¨
    function renderList(data) {
        const container = document.getElementById('list-container');
        if (!data || data.length === 0) {
            container.innerHTML = "<div style='text-align:center;color:#94a3b8;padding:20px;'>ç›®å‰æ²’æœ‰åº«å­˜è³‡æ–™</div>";
            return;
        }

        container.innerHTML = data.map(item => {
            const date = formatDateField(item.lastInboundDate);
            const qty = item.qty ?? 0;
            const qtyColor = qty < 5 ? 'var(--danger)' : 'var(--primary)';
            const name = item.name || "æœªå‘½å";
            const id = item.id || "";

            return `
                <div class="list-item" onclick="showDetail('${id}')">
                    <div class="list-main">
                        <div class="list-title">${name} (${id})</div>
                        <div class="list-sub">æœ€å¾Œå…¥åº«ï¼š${date}</div>
                    </div>
                    <div class="list-qty" style="color:${qtyColor};">${qty}</div>
                </div>
            `;
        }).join('');
    }

    // æœå°‹éæ¿¾
    function filterList() {
        const keyword = (document.getElementById('search-input').value || "").trim().toLowerCase();
        if (!keyword) {
            renderList(allData);
            return;
        }
        const filtered = allData.filter(item => {
            const text = `${item.name || ''} ${item.id || ''}`.toLowerCase();
            return text.includes(keyword);
        });
        renderList(filtered);
    }

    // åŒ¯å‡º CSV
    function exportToExcel() {
        if (!allData || allData.length === 0) {
            alert("ç›®å‰æ²’æœ‰ä»»ä½•åº«å­˜è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚");
            return;
        }

        const header = ["ID", "å“å", "æ•¸é‡", "æœ€å¾Œå…¥åº«æ—¥", "å­˜æ”¾ä½ç½®"];
        const rows = allData.map(item => {
            const id = item.id || "";
            const name = item.name || "";
            const qty = item.qty ?? 0;
            const date = formatDateField(item.lastInboundDate);
            const location = item.location || "";
            return [id, name, qty, date, location];
        });

        const escapeCSV = (val) => {
            const str = String(val ?? "");
            if (/[",\n]/.test(str)) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        let csv = header.map(escapeCSV).join(",") + "\n";
        csv += rows.map(r => r.map(escapeCSV).join(",")).join("\n");

        const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const today = new Date().toISOString().slice(0, 10);
        a.download = `inventory_${today}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ç´€éŒ„é é¢
    db.collection("logs").orderBy("timestamp", "desc").onSnapshot(snap => {
        const container = document.getElementById('logs-container');
        container.innerHTML = "";

        if (snap.empty) {
            container.innerHTML = "<div style='text-align:center; padding:20px; color:#94a3b8;'>ç›®å‰æ²’æœ‰ä»»ä½•ç•°å‹•ç´€éŒ„</div>";
            return;
        }

        snap.forEach(doc => {
            const d = doc.data();
            const time = d.timestamp && typeof d.timestamp.toDate === 'function'
                ? d.timestamp.toDate().toLocaleString()
                : 'è™•ç†ä¸­...';
            const color = (d.action || "").includes('å…¥åº«') ? 'var(--success)' : 'var(--danger)';
            const actionText = d.action || '';
            const amount = d.amount ?? 0;

            container.innerHTML += `
                <div class="list-item">
                    <div class="list-main">
                        <div class="list-title">${d.productName || "æœªå‘½å"}</div>
                        <div class="list-sub">${time}</div>
                    </div>
                    <div style="text-align:right; font-size:0.88rem;">
                        <span style="color:${color}; font-weight:bold;">${actionText} ${amount}</span>
                    </div>
                </div>
            `;
        });
    });

    // è©³ç´°è¦–çª—
    function showDetail(id) {
        const modal = document.getElementById('detail-modal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';

        db.collection("inventory").doc(id).get().then(doc => {
            if (!doc.exists) return;
            const d = doc.data();
            const dateStr = formatDateField(d.lastInboundDate);

            document.getElementById('modal-title').innerText = d.name || "å•†å“è©³æƒ…";
            document.getElementById('detail-id').innerText = d.id || id;
            document.getElementById('detail-inbound-date').innerText = dateStr;
            document.getElementById('detail-name').value = d.name || "";
            document.getElementById('detail-location').value = d.location || "";
            const qtyInput = document.getElementById('detail-qty-input');
            qtyInput.value = d.qty ?? 0;
            qtyInput.setAttribute('data-item-id', id);
        });

        db.collection("logs").where("productId", "==", id)
            .orderBy("timestamp", "desc")
            .limit(30)
            .get()
            .then(snapshot => {
                const list = document.getElementById('detail-history-list');
                list.innerHTML = "";
                if (snapshot.empty) {
                    list.innerHTML = `<li style="text-align:center; color:#94a3b8; padding:18px;">ç„¡æ­·å²ç´€éŒ„</li>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const time = d.timestamp && typeof d.timestamp.toDate === 'function'
                        ? d.timestamp.toDate().toLocaleString()
                        : 'è™•ç†ä¸­...';
                    const color = (d.action || "").includes('å…¥åº«') ? 'var(--success)' : 'var(--danger)';
                    const action = d.action || '';
                    const amount = d.amount ?? 0;

                    list.innerHTML += `
                        <li class="history-item">
                            <span class="history-time">${time}</span>
                            <span style="color:${color}; font-weight:bold;">${action} ${amount}</span>
                        </li>
                    `;
                });
            })
            .catch(error => {
                console.error("Firestore Index Error:", error);
                const list = document.getElementById('detail-history-list');
                list.innerHTML =
                    `<li style="color:var(--danger); padding:18px;">è¼‰å…¥ç´€éŒ„å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç´¢å¼•å°šæœªå»ºç«‹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</li>`;
            });
    }

    function updateDetailQty() {
        const inputEl = document.getElementById('detail-qty-input');
        const id = inputEl.getAttribute('data-item-id');
        const newQty = parseInt(inputEl.value, 10);

        if (!id || isProcessing) return;
        if (isNaN(newQty) || newQty < 0) {
            alert("æ•¸é‡å¿…é ˆæ˜¯ 0 æˆ–æ­£æ•´æ•¸");
            return;
        }

        vibrate([30]);
        isProcessing = true;

        db.collection('inventory').doc(id).get().then(doc => {
            const oldQty = doc.data()?.qty ?? 0;
            const diff = newQty - oldQty;

            if (diff === 0) {
                alert("æ•¸é‡æ²’æœ‰è®Šæ›´");
                return null;
            }

            const action = diff > 0 ? "æ‰‹å‹•å…¥åº«" : "æ‰‹å‹•å‡ºåº«";
            const amount = Math.abs(diff);

            const batch = db.batch();
            batch.update(doc.ref, {
                qty: newQty,
                updatedAt: ServerTimestamp
            });

            const logRef = db.collection("logs").doc();
            batch.set(logRef, {
                productId: id,
                productName: document.getElementById('detail-name').value || "æœªå‘½å",
                action: action,
                amount: amount,
                timestamp: ServerTimestamp
            });

            return batch.commit();
        }).then(result => {
            if (result !== null) {
                vibrate([50, 50, 50]);
                alert("åº«å­˜èª¿æ•´æˆåŠŸï¼");
                showDetail(id); // é‡æ–°æ›´æ–°ç•«é¢
            }
        }).catch(err => {
            console.error("Manual Adjust Error:", err);
            alert("èª¿æ•´å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™ã€‚");
        }).finally(() => {
            isProcessing = false;
        });
    }

    function updateDetailInfo(field) {
        const id = document.getElementById('detail-qty-input').getAttribute('data-item-id');
        const value = document.getElementById(`detail-${field}`).value;
        if (!id) return;
        db.collection("inventory").doc(id).update({
            [field]: value,
            updatedAt: ServerTimestamp
        });
    }

    function closeDetail() {
        const modal = document.getElementById('detail-modal');
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    // è£½ä½œ QRCode
    function makeQR() {
        vibrate([50]);
        const text = (document.getElementById('new-code').value || "").trim();
        if (!text) {
            alert("è«‹å…ˆè¼¸å…¥å•†å“ç·¨è™Ÿ");
            return;
        }

        const qrcodeContainer = document.getElementById('qrcode');
        qrcodeContainer.innerHTML = "";

        if (typeof QRCode !== 'undefined') {
            new QRCode(qrcodeContainer, {
                text: text,
                width: 128,
                height: 128
            });
        } else {
            alert("QRCode æ¨¡çµ„è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
        }
    }

    // View åˆ‡æ›
    async function switchView(view) {
        const sections = ['scan', 'list', 'logs', 'create'];
        sections.forEach(v => {
            const el = document.getElementById(`view-${v}`);
            if (el) el.style.display = (v === view) ? 'block' : 'none';
        });

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === view);
        });

        const main = document.getElementById('main-content-scroll');

        if (view === 'scan') {
            main.scrollTop = 0;
            main.style.overflowY = 'auto';
            await startCamera();
        } else {
            main.style.overflowY = 'auto';
            await stopCamera();
        }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        updateStatusDot(navigator.onLine);
        window.addEventListener('online', () => updateStatusDot(true));
        window.addEventListener('offline', () => updateStatusDot(false));

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const view = btn.dataset.view;
                switchView(view);
            });
        });

        // é è¨­é€²å…¥æƒæé 
        switchView('scan');
    });
</script>
</body>
</html>
