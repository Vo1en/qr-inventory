<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ™ºæ…§åº«å­˜ç³»çµ± Ultra</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --card: #ffffff;
            --nav-height: 70px;
            --header-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #cbd5e1; /* é›»è…¦ç‰ˆèƒŒæ™¯æ·±ä¸€é»ï¼Œå‡¸é¡¯ä¸­é–“ */
            margin: 0; padding: 0; 
            height: 100vh; height: 100dvh; 
            overflow: hidden;
            display: flex; justify-content: center;
        }

        /* App å®¹å™¨ */
        .app-wrapper {
            width: 100%; max-width: 480px; /* é™åˆ¶å¯¬åº¦åƒæ‰‹æ©Ÿ */
            background-color: #f8fafc;
            height: 100%;
            display: flex; flex-direction: column;
            position: relative;
            box-shadow: 0 0 25px rgba(0,0,0,0.15);
        }

        /* é ‚éƒ¨æ¨™é¡Œåˆ— */
        header { 
            flex: 0 0 var(--header-height);
            background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h1 { margin: 0; font-size: 1.1rem; font-weight: 700; letter-spacing: 1px; }
        .status-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; transition: background 0.3s; }
        .status-dot.online { background: #4ade80; box-shadow: 0 0 8px #4ade80; }

        /* ä¸­é–“å…§å®¹å€ */
        main { 
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 15px; padding-bottom: 90px;
        }

        /* åº•éƒ¨å°èˆªåˆ— */
        nav {
            flex: 0 0 var(--nav-height);
            background: white; border-top: 1px solid #e5e7eb;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 20; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-btn {
            background: none; border: none; 
            color: #94a3b8; font-size: 0.75rem; font-weight: 600;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 5px; width: 100%; height: 100%; cursor: pointer;
        }
        .nav-btn.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 4px; }

        /* å¡ç‰‡èˆ‡å…ƒä»¶ */
        .card { background: var(--card); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        
        /* ç›¸æ©Ÿ */
        #camera-wrapper { position: relative; border-radius: 12px; overflow: hidden; background: black; height: 280px; display: flex; align-items: center; justify-content: center; }
        #reader { width: 100%; height: 100%; }
        #reader video { object-fit: cover; width: 100% !important; height: 100% !important; border-radius: 12px; }

        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
        input[type="text"], input[type="number"] {
            width: 100%; padding: 12px; text-align: center;
            border: 2px solid #e2e8f0; border-radius: 10px;
            font-size: 1.1rem; margin: 8px 0; background: #f8fafc;
        }
        input:focus { border-color: var(--primary); background: #fff; }

        .info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .current-stock { font-size: 1.5rem; font-weight: 800; color: var(--primary); }

        .action-area { background: #f1f5f9; padding: 15px; border-radius: 12px; margin-top: 10px; }
        .qty-input { font-size: 1.5rem !important; font-weight: bold; color: #333; }
        
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn {
            padding: 15px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: bold; color: white;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn:active { transform: scale(0.97); filter: brightness(95%); }
        .btn-in { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-out { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-gen { background: var(--primary); width: 100%; margin-top: 10px; }
        .btn-export { background: #0f766e; width: 100%; margin-bottom: 10px; font-size: 0.9rem; flex-direction: row; gap: 8px;}

        /* åˆ—è¡¨ */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .tag { padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .tag-in { background: #dcfce7; color: #166534; } .tag-out { background: #fee2e2; color: #991b1b; }

        /* æœå°‹èˆ‡ç½®é ‚ */
        .sticky-search { position: sticky; top: 0; background: #f8fafc; padding-bottom: 10px; z-index: 5; }
        .result-panel { display: none; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div class="app-wrapper">
    <header>
        <h1>ğŸ“¦ åº«å­˜ç³»çµ± Ultra</h1>
        <div id="status-light" class="status-dot"></div>
    </header>

    <main>
        <div id="view-scan">
            <div class="card" style="padding:0; margin-bottom: 10px;">
                <div id="camera-wrapper">
                    <div id="reader"></div>
                    <div style="position:absolute; color:white; font-size:0.9rem; z-index:2; pointer-events:none; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:20px;">ğŸ“· å°æº– QR Code</div>
                </div>
            </div>

            <div id="scan-result" class="card result-panel">
                <div style="text-align:center; color:#94a3b8; font-family:monospace; margin-bottom:5px;" id="res-id">---</div>
                <input type="text" id="res-name" placeholder="è¼¸å…¥å•†å“åç¨±" onchange="updateInfo()">
                
                <div class="info-row">
                    <span style="color:#64748b; font-size:0.9rem;">ç›®å‰åº«å­˜</span>
                    <span class="current-stock" id="res-qty">0</span>
                </div>

                <div class="action-area">
                    <div style="text-align:left; font-size:0.85rem; color:#64748b; margin-bottom:5px;">ç•°å‹•æ•¸é‡ï¼š</div>
                    <input type="number" id="op-amount" class="qty-input" value="1" min="1" inputmode="numeric" style="margin-bottom:15px;">
                    <div class="btn-row">
                        <button class="btn btn-in" onclick="handleStock(1)">ï¼‹ å…¥åº«</button>
                        <button class="btn btn-out" onclick="handleStock(-1)">ï¼ å‡ºåº«</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-list" style="display:none;">
            <div class="sticky-search">
                <input type="text" id="search-input" placeholder="ğŸ” æœå°‹å•†å“..." onkeyup="filterList()">
                <button class="btn btn-export" onclick="exportToExcel()">
                    <span>ğŸ“¥</span> åŒ¯å‡ºæˆ Excel (CSV)
                </button>
            </div>
            <div class="card" id="list-container">
                <div style="text-align:center; padding:20px; color:#94a3b8;">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div id="view-logs" style="display:none;">
            <div class="card">
                <h3 style="margin-top:0; font-size:1.1rem;">ğŸ“ è¿‘ 50 ç­†ç´€éŒ„</h3>
                <div id="logs-container"></div>
            </div>
        </div>

        <div id="view-create" style="display:none;">
            <div class="card" style="text-align:center;">
                <h3>ğŸ–¨ï¸ è£½ä½œæ¨™ç±¤</h3>
                <input type="text" id="new-code" placeholder="è¼¸å…¥ç·¨è™Ÿ (å¦‚: A-001)">
                <button class="btn btn-gen" onclick="makeQR()">ç”Ÿæˆ QR Code</button>
                <div id="qrcode" style="margin-top:20px; display:flex; justify-content:center;"></div>
            </div>
        </div>
    </main>

    <nav>
        <button class="nav-btn active" onclick="switchView('scan')"><span class="nav-icon">ğŸ“·</span>æƒæ</button>
        <button class="nav-btn" onclick="switchView('list')"><span class="nav-icon">ğŸ“¦</span>åº«å­˜</button>
        <button class="nav-btn" onclick="switchView('logs')"><span class="nav-icon">ğŸ“</span>ç´€éŒ„</button>
        <button class="nav-btn" onclick="switchView('create')"><span class="nav-icon">ğŸ·ï¸</span>è£½ç¢¼</button>
    </nav>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAUgk7DGfnCCt1-cTAhvD2Se4YZQEoXUE8",
        authDomain: "qr-inventory-2e995.firebaseapp.com",
        projectId: "qr-inventory-2e995",
        storageBucket: "qr-inventory-2e995.firebasestorage.app",
        messagingSenderId: "1041449207118",
        appId: "1:1041449207118:web:d8c66fa15024471f0d0a1f",
        measurementId: "G-YGQYMSS6E3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    db.collection("inventory").limit(1).get().then(()=>document.getElementById('status-light').classList.add('online'));

    let html5QrCode;
    let currentId = null;
    let isProcessing = false;
    let allData = [];

    function startCamera() {
        if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 }, (text) => {
            if (currentId === text) return;
            vibrate([50]); currentId = text; fetchData(text);
        }).catch(err => console.log("Camera Error", err));
    }
    function stopCamera() { if(html5QrCode && html5QrCode.isScanning) html5QrCode.stop(); }

    function fetchData(id) {
        document.getElementById('scan-result').style.display = 'block';
        document.getElementById('res-id').innerText = id;
        document.getElementById('op-amount').value = 1;
        db.collection("inventory").doc(id).onSnapshot(doc => {
            if (doc.exists) {
                const d = doc.data();
                document.getElementById('res-qty').innerText = d.qty;
                document.getElementById('res-name').value = d.name || "";
            } else {
                document.getElementById('res-qty').innerText = 0;
                document.getElementById('res-name').value = "";
                document.getElementById('res-name').placeholder = "æ–°å•†å“ - è«‹å‘½å";
            }
        });
    }

    function handleStock(direction) {
        if (!currentId || isProcessing) return;
        const amount = parseInt(document.getElementById('op-amount').value);
        if (isNaN(amount) || amount <= 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºæ•¸é‡");
        
        vibrate([30]); isProcessing = true;
        const change = amount * direction;
        const docRef = db.collection("inventory").doc(currentId);
        const batch = db.batch();
        const name = document.getElementById('res-name').value || "æœªå‘½å";

        docRef.get().then(doc => {
            if (!doc.exists) batch.set(docRef, { qty: change>0?change:0, name: name, id: currentId, updatedAt: new Date() });
            else batch.update(docRef, { qty: firebase.firestore.FieldValue.increment(change), name: name, updatedAt: new Date() });
            
            const logRef = db.collection("logs").doc();
            batch.set(logRef, { productId: currentId, productName: name, action: direction>0?"å…¥åº«":"å‡ºåº«", amount: amount, timestamp: new Date() });
            return batch.commit();
        }).then(() => { vibrate([50,50]); document.getElementById('op-amount').value = 1; })
          .catch(err => alert(err)).finally(() => isProcessing = false);
    }

    function updateInfo() { if(currentId) db.collection("inventory").doc(currentId).set({ name: document.getElementById('res-name').value, id: currentId }, { merge: true }); }

    // åˆ—è¡¨åŒæ­¥
    db.collection("inventory").onSnapshot(snap => {
        allData = [];
        snap.forEach(doc => allData.push({ ...doc.data(), id: doc.id }));
        renderList(allData);
    });

    function renderList(data) {
        const container = document.getElementById('list-container');
        if(data.length === 0) return container.innerHTML = "<div style='text-align:center;color:#ccc'>ç„¡è³‡æ–™</div>";
        container.innerHTML = data.map(item => `
            <div class="list-item">
                <div>
                    <div style="font-weight:600;">${item.name || "æœªå‘½å"}</div>
                    <div style="font-size:0.8rem; color:#94a3b8; font-family:monospace;">${item.id}</div>
                </div>
                <div style="font-size:1.2rem; font-weight:800; color:${item.qty < 5 ? 'var(--danger)' : 'var(--primary)'}">${item.qty}</div>
            </div>`).join('');
    }
    
    function filterList() {
        const key = document.getElementById('search-input').value.toLowerCase();
        renderList(allData.filter(i => (i.id+i.name).toLowerCase().includes(key)));
    }

    // â˜…â˜…â˜… æ–°å¢åŠŸèƒ½ï¼šåŒ¯å‡º Excel (CSV) â˜…â˜…â˜…
    function exportToExcel() {
        if(allData.length === 0) return alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º");
        
        // 1. åŠ å…¥ BOM è®“ Excel èƒ½æ­£ç¢ºè®€å–ä¸­æ–‡
        let csvContent = "\uFEFF"; 
        // 2. æ¨™é¡Œåˆ—
        csvContent += "å•†å“ç·¨è™Ÿ,å•†å“åç¨±,ç›®å‰åº«å­˜\n";
        
        // 3. å…§å®¹
        allData.forEach(row => {
            const name = (row.name || "").replace(/,/g, " "); // é¿å…é€—è™Ÿç ´å£æ ¼å¼
            csvContent += `${row.id},${name},${row.qty}\n`;
        });

        // 4. ä¸‹è¼‰æ©Ÿåˆ¶
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "åº«å­˜æ¸…å–®_" + new Date().toISOString().slice(0,10) + ".csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    db.collection("logs").orderBy("timestamp", "desc").limit(50).onSnapshot(snap => {
        document.getElementById('logs-container').innerHTML = snap.docs.map(doc => {
            const d = doc.data();
            const time = d.timestamp ? new Date(d.timestamp.toDate()).toLocaleTimeString([], {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}) : "--:--";
            return `<div class="list-item"><div><div style="font-weight:600">${d.productName}</div><div style="font-size:0.75rem; color:#94a3b8;">${time}</div></div>
            <div><span class="tag ${d.action==="å…¥åº«"?'tag-in':'tag-out'}">${d.action} ${d.amount}</span></div></div>`;
        }).join('');
    });

    function switchView(view) {
        ['scan', 'list', 'logs', 'create'].forEach(v => document.getElementById('view-'+v).style.display = (v===view)?'block':'none');
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(view === 'scan') setTimeout(startCamera, 300); else stopCamera();
    }

    function makeQR() {
        const text = document.getElementById('new-code').value;
        if(!text) return;
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById('qrcode'), { text: text, width: 128, height: 128 });
    }
    function vibrate(p) { if(navigator.vibrate) navigator.vibrate(p); }
    startCamera();
</script>
</body>
</html>
