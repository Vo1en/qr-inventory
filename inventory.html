<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>çµ‚æ¥µåº«å­˜ç³»çµ± V4.0 - GitHub Ready</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">

    <!-- Firebase Modular SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, updateDoc, setDoc, query, orderBy, serverTimestamp, runTransaction, getDoc, where, limit, FieldValue } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        
        // --- 1. å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ– ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // ä¿®æ­£éŒ¯èª¤ï¼šé¿å…è‡ªæˆ‘å¼•ç”¨ 'initialAuthToken'ï¼Œæª¢æŸ¥ __initial_auth_token è®Šæ•¸
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let html5QrCode; 
        
        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
        let currentItem = { id: null, name: '', qty: 0, location: '' };
        let allInventoryData = [];
        let currentView = 'scan';

        // è¼”åŠ©å‡½å¼
        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'è¼‰å…¥ä¸­...';
            return timestamp.toDate().toLocaleString('zh-TW', { hour12: false });
        };
        const vibrate = (pattern) => { if (navigator.vibrate) navigator.vibrate(pattern); };
        const setFlashMessage = (message, isSuccess = false) => {
            const banner = document.getElementById('error-banner');
            banner.innerText = message;
            banner.className = `fixed bottom-20 left-1/2 -translate-x-1/2 z-50 p-3 text-white rounded-lg shadow-2xl max-w-xs w-full text-sm text-center animate-pulse transition duration-300 cursor-pointer ${isSuccess ? 'bg-green-600' : 'bg-red-600'}`;
            banner.style.display = 'block';
            setTimeout(() => banner.style.display = 'none', 3000);
        };
        
        // --- 2. Firebase & Auth å•Ÿå‹• ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // ç™»å…¥é‚è¼¯
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id-display').innerText = `ID: ${userId.substring(0, 8)}...`;
                        document.getElementById('status-dot').className = 'w-3 h-3 rounded-full bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.8)]';
                        // é–‹å§‹è¨‚é–±æ•¸æ“š
                        setupFirestoreListeners();
                        // é¦–æ¬¡å•Ÿå‹•ç›¸æ©Ÿ (FIX: ç§»é™¤å»¶é²ï¼ŒåŠ å¿«å•Ÿå‹•)
                        startCamera();
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Authentication Error:", error);
                            setFlashMessage("èº«ä»½é©—è­‰å¤±æ•—ï¼ŒåŠŸèƒ½å—é™ã€‚");
                            userId = 'anonymous'; 
                            isAuthReady = true;
                            document.getElementById('user-id-display').innerText = `ID: N/A`;
                            document.getElementById('status-dot').className = 'w-3 h-3 rounded-full bg-red-400';
                            setupFirestoreListeners();
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase Init Failed:", e);
                setFlashMessage("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ã€‚");
            }
        }
        
        // --- 3. Firestore å³æ™‚ç›£è½å™¨ ---
        function setupFirestoreListeners() {
            const inventoryPath = `/artifacts/${appId}/users/${userId}/inventory_v4`;
            const logsPath = `/artifacts/${appId}/users/${userId}/logs_v4`;

            // åº«å­˜åˆ—è¡¨è¨‚é–±
            onSnapshot(collection(db, inventoryPath), (snapshot) => {
                allInventoryData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                renderList(allInventoryData);
            }, (error) => {
                console.error("Inventory Snapshot Error:", error);
                setFlashMessage("ç„¡æ³•è¼‰å…¥åº«å­˜æ•¸æ“šã€‚");
            });

            // æ“ä½œç´€éŒ„è¨‚é–± (æœ€å¤š 50 ç­†)
            const logsQuery = query(collection(db, logsPath), orderBy("timestamp", "desc"), limit(50));
            onSnapshot(logsQuery, (snapshot) => {
                renderLogs(snapshot.docs.map(doc => doc.data()));
            }, (error) => {
                console.error("Logs Snapshot Error:", error);
            });
        }
        
        // --- 4. æƒæå™¨æ§åˆ¶ (ä¿®æ­£: ä½¿ç”¨ getCameras() ç¢ºä¿è¨­å‚™å­˜åœ¨) ---
        async function startCamera() {
            if (typeof window.Html5Qrcode === 'undefined') {
                setFlashMessage("QR æƒæåº«è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...");
                return;
            }
            if (!html5QrCode) html5QrCode = new window.Html5Qrcode("scanner-container");
            
            const scannerText = document.querySelector('#scanner-container p');
            if (scannerText) scannerText.innerText = "æ­£åœ¨åµæ¸¬å¯ç”¨ç›¸æ©Ÿ...";

            const qrboxFunction = (viewfinderWidth, viewfinderHeight) => {
                let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                let size = Math.floor(minEdge * 0.7);
                return { width: size, height: size };
            };

            const config = { fps: 10, qrbox: qrboxFunction };
            let cameraId = null;
            let cameraLabel = 'default';

            try {
                // 1. å–å¾—æ‰€æœ‰å¯ç”¨ç›¸æ©Ÿ
                const devices = await window.Html5Qrcode.getCameras();
                if (devices && devices.length) {
                    // 2. å„ªå…ˆé¸æ“‡å¾Œç½®é¡é ­ (åŒ…å« 'back', 'environment', 'external' ç­‰é—œéµå­—)
                    const environmentCam = devices.find(d => 
                        d.label.toLowerCase().includes('back') || 
                        d.label.toLowerCase().includes('environment') || 
                        d.label.toLowerCase().includes('external')
                    );
                    
                    if (environmentCam) {
                        cameraId = environmentCam.id;
                        cameraLabel = environmentCam.label;
                    } else {
                        // 3. å¦å‰‡ä½¿ç”¨ç¬¬ä¸€å€‹æ‰¾åˆ°çš„è¨­å‚™ (é€šå¸¸æ˜¯å‰ç½®æˆ–é è¨­)
                        cameraId = devices[0].id;
                        cameraLabel = devices[0].label;
                    }
                    
                    if (scannerText) scannerText.innerText = `åµæ¸¬åˆ°ç›¸æ©Ÿ: ${cameraLabel}ï¼Œæ­£åœ¨å•Ÿå‹•...`;

                    // 4. ä½¿ç”¨è¨­å‚™ ID å•Ÿå‹•æƒæå™¨
                    await html5QrCode.start(
                        cameraId,
                        config, 
                        (decodedText) => { vibrate([50]); fetchItemData(decodedText); },
                        (errorMessage) => { /* å¿½ç•¥è©³ç´°éŒ¯èª¤ */ }
                    );
                } else {
                    // æ‰¾ä¸åˆ°ä»»ä½•ç›¸æ©Ÿ
                    if (scannerText) scannerText.innerText = "ğŸš¨ æ‰¾ä¸åˆ°ä»»ä½•ç›¸æ©Ÿè¨­å‚™ã€‚";
                    setFlashMessage("ğŸš¨ æ‰¾ä¸åˆ°ç›¸æ©Ÿã€‚è«‹æª¢æŸ¥æ¬Šé™ã€‚", false);
                }
            } catch (err) {
                // å•Ÿå‹•å¤±æ•—æˆ–æ¬Šé™è¢«æ‹’
                console.error("Camera startup error:", err);
                if (err.name === 'NotAllowedError' || err.message.includes('permission')) {
                     if (scannerText) scannerText.innerText = "ğŸš¨ å•Ÿå‹•å¤±æ•—ï¼šè«‹æˆäºˆç›¸æ©Ÿæ¬Šé™ã€‚";
                     setFlashMessage("ğŸš¨ è«‹æˆäºˆç›¸æ©Ÿæ¬Šé™ä»¥é€²è¡Œæƒæã€‚", false);
                } else if (err.name === 'NotFoundError') {
                    if (scannerText) scannerText.innerText = "ğŸš¨ æ‰¾ä¸åˆ°æŒ‡å®šçš„ç›¸æ©Ÿã€‚";
                    setFlashMessage("ğŸš¨ æ‰¾ä¸åˆ°æŒ‡å®šçš„ç›¸æ©Ÿã€‚è«‹æª¢æŸ¥è¨­å‚™ã€‚", false);
                } else {
                    if (scannerText) scannerText.innerText = "ğŸš¨ ç›¸æ©Ÿå•Ÿå‹•ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚";
                    setFlashMessage("ğŸš¨ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ã€‚", false);
                }
            }
        }

        function stopCamera() {
            if (html5QrCode && html5QrCode.isScanning) {
                // é‡è¨­æƒæå®¹å™¨çš„æç¤ºæ–‡æœ¬
                const scannerText = document.querySelector('#scanner-container p');
                if (scannerText) scannerText.innerText = "æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...";
                html5QrCode.stop().catch(err => console.error("Camera stop failed:", err));
            }
        }

        // --- 5. æƒæçµæœè™•ç† ---
        async function fetchItemData(id) {
            // FIX: å¦‚æœæƒæåˆ°ç›¸åŒçš„IDï¼Œå‰‡ä¸é‡è¤‡è™•ç†ï¼Œé¿å…é‡è¤‡éœ‡å‹•å’ŒAPIå‘¼å«
            if (currentItem.id === id) { 
                return; 
            }
            
            const docRef = doc(db, `/artifacts/${appId}/users/${userId}/inventory_v4`, id);
            
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    currentItem = { id: docSnap.id, ...docSnap.data() };
                } else {
                    currentItem = { id: id, name: '', qty: 0, location: '' };
                }
                updateScanViewUI();
            } catch (e) {
                console.error("Fetch Item Error:", e);
                setFlashMessage("è®€å–å•†å“è³‡è¨Šå¤±æ•—ã€‚");
            }
        }

        function updateScanViewUI() {
            document.getElementById('res-id').innerText = currentItem.id || "---";
            document.getElementById('res-name').value = currentItem.name || "";
            document.getElementById('res-name').placeholder = currentItem.id ? "è¼¸å…¥å•†å“åç¨± (å¤±ç„¦å¾Œå„²å­˜)" : "æ–°å•†å“ - è«‹å‘½å";
            document.getElementById('res-qty').innerText = currentItem.qty;
            document.getElementById('op-amount').value = 1; // é‡è¨­æ“ä½œæ•¸é‡
        }

        function handleNameUpdate() {
            if (!currentItem.id || !db) return;
            const newName = document.getElementById('res-name').value;
            if (newName === currentItem.name) return;
            currentItem.name = newName;
            setDoc(doc(db, `/artifacts/${appId}/users/${userId}/inventory_v4`, currentItem.id), { name: newName, updatedAt: serverTimestamp() }, { merge: true });
        }

        // --- 6. åº«å­˜æ“ä½œ (å…¥åº«/å‡ºåº«) ---
        async function handleStock(direction) {
            if (!currentItem.id || !db || !userId) return;
            const opAmountEl = document.getElementById('op-amount');
            const amount = parseInt(opAmountEl.value);
            
            if (isNaN(amount) || amount <= 0) return setFlashMessage("æ•¸é‡å¿…é ˆå¤§æ–¼ 0");

            const inventoryPath = `/artifacts/${appId}/users/${userId}/inventory_v4`;
            const logsPath = `/artifacts/${appId}/users/${userId}/logs_v4`;
            const itemRef = doc(db, inventoryPath, currentItem.id);
            const change = amount * direction;

            try {
                await runTransaction(db, async (transaction) => {
                    const itemDoc = await transaction.get(itemRef);
                    const currentQty = itemDoc.exists() ? itemDoc.data().qty : 0;
                    const newQty = currentQty + change;

                    if (newQty < 0) throw new Error("åº«å­˜ä¸è¶³ï¼Œç„¡æ³•å‡ºåº«ï¼");

                    const name = document.getElementById('res-name').value || 'æœªå‘½å';
                    const updateFields = {
                        name: name,
                        qty: newQty,
                        updatedAt: serverTimestamp(),
                        id: currentItem.id,
                    };

                    if (direction > 0) updateFields.lastInboundDate = serverTimestamp();

                    transaction.set(itemRef, updateFields, { merge: true });

                    // å¯«å…¥ç´€éŒ„
                    const logRef = doc(collection(db, logsPath));
                    transaction.set(logRef, {
                        productId: currentItem.id,
                        productName: name,
                        action: direction > 0 ? "å…¥åº«" : "å‡ºåº«",
                        amount: amount,
                        timestamp: serverTimestamp(),
                    });
                });

                vibrate([50, 50]);
                setFlashMessage("æ“ä½œæˆåŠŸï¼åº«å­˜å·²æ›´æ–°ã€‚", true);
                opAmountEl.value = 1;
            } catch (e) {
                setFlashMessage(e.message);
                vibrate([100, 100, 100]);
                console.error("Transaction failed:", e);
            }
        }
        
        // --- 7. åˆ—è¡¨å’Œç´€éŒ„æ¸²æŸ“ ---
        function renderList(data) {
            const container = document.getElementById('list-container');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            const filteredData = data
                .filter(item =>
                    item.id.toLowerCase().includes(searchTerm) ||
                    (item.name || '').toLowerCase().includes(searchTerm)
                )
                .sort((a, b) => b.qty - a.qty);

            if(filteredData.length === 0) {
                return container.innerHTML = `<p class="text-center text-gray-500 py-10">${searchTerm ? "ç„¡ç¬¦åˆæ¢ä»¶çš„å•†å“" : "åº«å­˜åˆ—è¡¨ç‚ºç©º..."}</p>`;
            }

            container.innerHTML = filteredData.map(item => {
                const isLowStock = item.qty < 5;
                const dateStr = item.lastInboundDate ? formatTimestamp(item.lastInboundDate).split(' ')[0] : 'ç„¡ç´€éŒ„';
                const colorClass = isLowStock ? 'text-red-500' : 'text-green-600';
                const borderClass = isLowStock ? 'border-red-500' : 'border-green-500';

                return `
                    <div onclick="window.showDetailModal('${item.id}')"
                        class="flex justify-between items-center p-4 bg-white rounded-xl shadow-md cursor-pointer hover:shadow-lg transition border-l-4 ${borderClass}">
                        <div class="flex flex-col flex-1 truncate">
                            <span class="font-semibold text-gray-800 truncate">${item.name || "æœªå‘½å"}</span>
                            <span class="text-xs text-gray-500 font-mono">ID: ${item.id}</span>
                            <span class="text-xs text-gray-500 mt-1">æœ€å¾Œå…¥åº«: ${dateStr}</span>
                        </div>
                        <div class="text-3xl font-extrabold ${colorClass}">
                            ${item.qty}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLogs(logsData) {
            const container = document.getElementById('logs-container');
            if (logsData.length === 0) {
                return container.innerHTML = `<p class="text-center text-gray-500 py-10">ç„¡æ­·å²ç´€éŒ„</p>`;
            }

            container.innerHTML = logsData.map(log => {
                const isOutbound = log.action.includes('å‡ºåº«');
                const color = isOutbound ? 'text-red-600' : 'text-green-600';
                const sign = isOutbound ? '-' : '+';
                const time = formatTimestamp(log.timestamp);

                return `
                    <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm">
                        <div class="flex flex-col flex-1 truncate">
                            <span class="font-medium text-gray-800 truncate">${log.productName}</span>
                            <span class="text-xs text-gray-500">${time}</span>
                        </div>
                        <div class="text-right flex-shrink-0 ml-4">
                            <span class="font-extrabold text-lg ${color}">${sign}${log.amount}</span>
                            <span class="block text-xs text-gray-600">${log.action}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- 8. å•†å“è©³æƒ…æ¨¡æ…‹æ¡†é‚è¼¯ ---
        window.showDetailModal = async function(id) {
            const modal = document.getElementById('detail-modal');
            modal.classList.add('opacity-100', 'pointer-events-auto');
            document.getElementById('modal-content').classList.remove('translate-y-full');
            
            // è¼‰å…¥å•†å“åŸºæœ¬æ•¸æ“š
            const docRef = doc(db, `/artifacts/${appId}/users/${userId}/inventory_v4`, id);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) return setFlashMessage("å•†å“ä¸å­˜åœ¨ã€‚");
            
            const d = docSnap.data();
            const dateStr = d.lastInboundDate ? formatTimestamp(d.lastInboundDate).split(' ')[0] : 'ç„¡ç´€éŒ„';

            document.getElementById('modal-title').innerText = d.name || "å•†å“è©³æƒ…";
            document.getElementById('detail-id').innerText = d.id;
            document.getElementById('detail-inbound-date').innerText = dateStr;
            document.getElementById('detail-name').value = d.name || "";
            document.getElementById('detail-location').value = d.location || "";
            document.getElementById('detail-qty-input').value = d.qty;
            document.getElementById('detail-qty-input').setAttribute('data-item-id', id);

            // è¼‰å…¥æ­·å²ç´€éŒ„
            const logsPath = `/artifacts/${appId}/users/${userId}/logs_v4`;
            const detailLogsQuery = query(collection(db, logsPath), where("productId", "==", id), orderBy("timestamp", "desc"), limit(20));
            const historyList = document.getElementById('detail-history-list');
            historyList.innerHTML = `<li class="text-center text-gray-500 py-4">è¼‰å…¥ä¸­...</li>`;
            
            const snapshot = await getDocs(detailLogsQuery); // é€™è£¡ä½¿ç”¨ getDocs æ›¿ä»£ onSnapshot
            
            if (snapshot.empty) {
                historyList.innerHTML = `<li class="text-center text-gray-500 py-4">ç„¡æ­·å²ç´€éŒ„</li>`;
            } else {
                historyList.innerHTML = snapshot.docs.map(logDoc => {
                    const log = logDoc.data();
                    const time = formatTimestamp(log.timestamp);
                    const isOutbound = log.action.includes('å‡ºåº«');
                    const color = isOutbound ? 'text-red-500' : 'text-green-500';
                    const sign = isOutbound ? '-' : '+';
                    
                    return `
                        <li class="flex justify-between items-center text-sm border-b last:border-b-0 py-2">
                            <span class="text-gray-600 font-medium">${log.action}</span>
                            <div class="text-right">
                                <span class="font-bold ${color}">${sign}${log.amount}</span>
                                <span class="block text-xs text-gray-400">${time}</span>
                            </div>
                        </li>
                    `;
                }).join('');
            }
        }

        window.closeDetailModal = function() {
            document.getElementById('modal-content').classList.add('translate-y-full');
            document.getElementById('detail-modal').classList.remove('opacity-100', 'pointer-events-auto');
        }
        
        window.updateDetailInfo = async function() {
            const id = document.getElementById('detail-qty-input').getAttribute('data-item-id');
            const name = document.getElementById('detail-name').value;
            const location = document.getElementById('detail-location').value;
            
            if (!id || !db) return;
            
            try {
                await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/inventory_v4`, id), { 
                    name: name, 
                    location: location, 
                    updatedAt: serverTimestamp() 
                });
                setFlashMessage("åŸºæœ¬è³‡è¨Šæ›´æ–°æˆåŠŸï¼", true);
            } catch (e) {
                console.error("Update Detail Error:", e);
                setFlashMessage("æ›´æ–°å¤±æ•—ã€‚");
            }
        }

        window.handleManualUpdate = async function() {
            const inputEl = document.getElementById('detail-qty-input');
            const id = inputEl.getAttribute('data-item-id');
            const newQty = parseInt(inputEl.value);
            
            if (!id || isNaN(newQty) || newQty < 0) return setFlashMessage("æ•¸é‡ç„¡æ•ˆæˆ– ID ç¼ºå¤±ã€‚");

            const inventoryPath = `/artifacts/${appId}/users/${userId}/inventory_v4`;
            const logsPath = `/artifacts/${appId}/users/${userId}/logs_v4`;
            const itemRef = doc(db, inventoryPath, id);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const itemDoc = await transaction.get(itemRef);
                    const oldQty = itemDoc.exists() ? itemDoc.data().qty : 0;
                    const diff = newQty - oldQty;

                    if (diff === 0) throw new Error("æ•¸é‡æœªè®Šæ›´");

                    const action = diff > 0 ? "æ‰‹å‹•å…¥åº«" : "æ‰‹å‹•å‡ºåº«";
                    const amount = Math.abs(diff);

                    // æ›´æ–°å•†å“åŸºæœ¬è³‡è¨Šå’Œåº«å­˜
                    transaction.update(itemRef, { 
                        qty: newQty, 
                        updatedAt: serverTimestamp() 
                    });

                    // å¯«å…¥ç´€éŒ„
                    const logRef = doc(collection(db, logsPath));
                    transaction.set(logRef, {
                        productId: id,
                        productName: document.getElementById('detail-name').value,
                        action: action,
                        amount: amount,
                        timestamp: serverTimestamp(),
                    });
                });

                vibrate([50, 50, 50]);
                setFlashMessage("åº«å­˜èª¿æ•´æˆåŠŸï¼", true);
                window.showDetailModal(id); // é‡æ–°è¼‰å…¥è©³æƒ…
            } catch (e) {
                setFlashMessage(e.message);
                console.error("Manual Adjust Error:", e);
            }
        }
        
        // --- 9. è¼”åŠ©åŠŸèƒ½ ---
        window.switchView = function(view) {
            currentView = view; // æ›´æ–°ç•¶å‰è¦–åœ–ç‹€æ…‹
            const mainContent = document.getElementById('main-content-scroll');
            const views = { 'scan': 'view-scan', 'list': 'view-list', 'logs': 'view-logs', 'create': 'view-create' };
            
            // FIX 1: æ ¹æ“šè¦–åœ–åˆ‡æ›ä¸»å…§å®¹å€å¡Šçš„æ²å‹•è¨­å®š
            if (view === 'scan') {
                mainContent.classList.add('overflow-hidden'); // é–å®šæƒæé é¢ä¸æ²å‹•
                mainContent.classList.remove('overflow-y-auto');
            } else {
                mainContent.classList.add('overflow-y-auto');
                mainContent.classList.remove('overflow-hidden');
            }

            Object.keys(views).forEach(v => {
                document.getElementById(views[v]).classList.add('hidden');
            });
            document.getElementById(views[view]).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-indigo-600'));
            document.querySelector(`.nav-btn[data-view="${view}"]`).classList.add('text-indigo-600');

            if (view === 'scan') {
                // FIX: ç¢ºä¿åˆ‡æ›åˆ°æƒæé é¢æ™‚ï¼Œé‡è¨­ currentItemï¼Œå…è¨±æƒæåŒä¸€å€‹QR code
                currentItem = { id: null, name: '', qty: 0, location: '' };
                updateScanViewUI();
                setTimeout(startCamera, 300);
            } else {
                stopCamera();
                if (view === 'list') renderList(allInventoryData);
            }
        }
        
        window.filterList = function() {
            renderList(allInventoryData);
        }

        window.fillMaxStock = function() {
            const currentQty = parseInt(document.getElementById('res-qty').innerText) || 0;
            document.getElementById('op-amount').value = currentQty;
            vibrate([50]);
        }
        
        window.makeQR = function() {
            vibrate([50]);
            const text = document.getElementById('new-code').value;
            if(!text) return;
            
            const qrcodeContainer = document.getElementById('qrcode-display-canvas');
            if (typeof window.QRCode !== 'undefined') {
                qrcodeContainer.innerHTML = '';
                new window.QRCode(qrcodeContainer, {
                    text: text,
                    width: 150,
                    height: 150,
                    colorDark : "#0f172a",
                    colorLight : "#ffffff",
                    correctLevel : window.QRCode.CorrectLevel.H
                });
            } else {
                setFlashMessage("QRCode å…ƒä»¶è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
            }
        }

        window.exportToExcel = function() {
            vibrate([50]);
            if (allInventoryData.length === 0) return setFlashMessage("æ²’æœ‰åº«å­˜æ•¸æ“šå¯åŒ¯å‡ºã€‚");

            const header = ["å•†å“ç·¨è™Ÿ (ID)", "å“å", "åº«å­˜æ•¸é‡", "å­˜æ”¾ä½ç½®", "æœ€å¾Œå…¥åº«æ—¥", "æ›´æ–°æ™‚é–“"].join(',');
            const csvRows = allInventoryData.map(item => {
                const lastInbound = item.lastInboundDate ? formatTimestamp(item.lastInboundDate) : '';
                const updatedAt = item.updatedAt ? formatTimestamp(item.updatedDate) : '';
                return [
                    `"${item.id}"`,
                    `"${item.name || 'æœªå‘½å'}"`,
                    item.qty,
                    `"${item.location || ''}"`,
                    `"${updatedAt}"`
                ].join(',');
            });

            const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + header + "\n" + csvRows.join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `inventory_export_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- 10. æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• ---
        document.addEventListener('DOMContentLoaded', initializeFirebase);

    </script>
    
    <!-- QR Code Core Libraries (Global) -->
    <script src="https://unpkg.com/html5-qrcode" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>

    <style>
        /* åŸºç¤æ¨£å¼å’Œ Tailwind è¦†è“‹ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb; /* ç°è‰²èƒŒæ™¯ */
            height: 100vh;
            height: 100dvh;
        }
        .app-wrapper {
            width: 100%;
            max-width: 480px;
            background-color: #f9fafb; /* æ·ºç° App èƒŒæ™¯ */
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 25px rgba(0,0,0,0.15);
        }
        /* Fix for Safari bottom padding */
        nav { padding-bottom: env(safe-area-inset-bottom); }

        /* ç›¸æ©Ÿå®¹å™¨ */
        #scanner-container video {
            object-fit: cover !important;
            width: 100% !important;
            height: 100% !important;
        }
        /* éš±è—åˆ—å°æŒ‰éˆ• */
        @media print {
            .print\\:hidden { display: none !important; }
            .print\\:block { display: block !important; }
            .print-area { margin: 0; box-shadow: none; border: none; }
        }
    </style>
</head>

<body class="flex justify-center overflow-hidden">

<div class="app-wrapper">
    <!-- Header -->
    <header class="flex-shrink-0 bg-indigo-700 text-white p-4 flex justify-between items-center shadow-lg">
        <h1 class="text-xl font-bold tracking-wider">ğŸ“¦ çµ‚æ¥µåº«å­˜ç³»çµ± V4.0</h1>
        <div class="flex items-center space-x-2">
            <span id="user-id-display" class="text-xs font-mono opacity-70">ID: è¼‰å…¥ä¸­...</span>
            <div id="status-dot" class="w-3 h-3 rounded-full bg-red-400" title="é€£ç·šç‹€æ…‹"></div>
        </div>
    </header>

    <!-- Content Area (Scrollable) -->
    <main id="main-content-scroll" class="flex-grow overflow-y-auto">
        
        <!-- 1. æƒæé é¢ (é è¨­é¡¯ç¤º) -->
        <!-- FIX 1: ç¢ºä¿ h-full flex flex-col ä½”æ»¿çˆ¶å®¹å™¨çš„å¯ç”¨é«˜åº¦ -->
        <div id="view-scan" class="h-full flex flex-col justify-start">
            
            <!-- FIX 2: ä½¿ç”¨ flex-shrink-0 ç¢ºä¿æ­¤å€å¡Šåœ¨æƒæé é¢ä¸è¢«å£“ç¸® -->
            <div class="p-2 space-y-2 flex-shrink-0 h-full flex flex-col">
                <!-- ç›¸æ©Ÿå®¹å™¨ï¼šä½¿ç”¨ flex-grow ä½”æ»¿æ‰€æœ‰å‰©é¤˜å‚ç›´ç©ºé–“ -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden border-4 border-indigo-500/50 flex-grow min-h-[100px] max-h-full">
                    <div id="scanner-container" class="w-full h-full bg-gray-900 flex items-center justify-center text-white text-lg">
                        <p>æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...</p>
                    </div>
                </div>

                <!-- FIX 4: å£“ç¸®å…§é‚Šè·å’Œå­—é«”å¤§å°ï¼Œæ¸›å°‘å‚ç›´ç©ºé–“ä½”ç”¨ -->
                <div class="bg-white p-3 rounded-xl shadow-xl space-y-2 flex-shrink-0 mt-2">
                    <p class="text-center font-mono text-xs text-gray-500 truncate"><span class='font-bold text-gray-700'>ID:</span> <span id="res-id">---</span></p>
                    
                    <input 
                        type="text" 
                        id="res-name" 
                        onchange="handleNameUpdate()"
                        placeholder="è«‹å…ˆæƒæå•†å“"
                        class="w-full p-1.5 border-2 border-gray-300 rounded-lg text-center font-bold text-sm focus:border-indigo-500 transition"
                    />

                    <div class="flex justify-between items-center bg-indigo-50 p-2 rounded-xl">
                        <span class="text-sm text-indigo-700 font-semibold">ç›®å‰åº«å­˜:</span>
                        <span id="res-qty" class="text-2xl font-extrabold text-indigo-600 transition-transform duration-300">0</span>
                    </div>

                    <div class="bg-gray-100 p-2 rounded-xl space-y-1">
                        <label class="text-xs font-semibold text-gray-700 block">ç•°å‹•æ•¸é‡:</label>
                        
                        <div class="flex gap-2">
                            <input 
                                type="number" 
                                id="op-amount" 
                                value="1" 
                                min="1" 
                                inputmode="numeric"
                                class="flex-grow p-1.5 border-2 border-gray-300 rounded-lg text-center font-semibold text-base"
                            />
                            <button 
                                onclick="fillMaxStock()"
                                class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-2 rounded-lg shadow transition duration-150 text-xs flex-shrink-0"
                            >
                                å¡«å…¥åº«å­˜
                            </button>
                        </div>

                        <div class="grid grid-cols-2 gap-2 pt-1">
                            <button 
                                onclick="handleStock(1)"
                                class="bg-green-500 hover:bg-green-600 text-white font-extrabold py-2.5 rounded-xl shadow-md transition transform hover:scale-[1.01] text-sm"
                            >
                                <span class="text-xl">+</span> å…¥åº«
                            </button>
                            <button 
                                onclick="handleStock(-1)"
                                class="bg-red-500 hover:bg-red-600 text-white font-extrabold py-2.5 rounded-xl shadow-md transition transform hover:scale-[1.01] text-sm"
                            >
                                <span class="text-xl">-</span> å‡ºåº«
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- 2. åº«å­˜åˆ—è¡¨é é¢ -->
        <div id="view-list" class="hidden h-full flex flex-col">
            <div class="sticky top-0 z-10 bg-gray-50 p-4 pb-2 shadow-inner border-b">
                <input
                    type="text"
                    id="search-input"
                    placeholder="ğŸ” æœå°‹å•†å“ç·¨è™Ÿæˆ–åç¨±..."
                    onkeyup="filterList()"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 transition mb-3"
                />
                <button 
                    onclick="exportToExcel()"
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-lg shadow transition"
                >
                    ğŸ“¥ åŒ¯å‡º Excel (CSV)
                </button>
            </div>
            
            <div id="list-container" class="flex-grow p-4 space-y-2">
                <p class="text-center text-gray-500 py-10">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <!-- 3. ç´€éŒ„é é¢ -->
        <div id="view-logs" class="hidden p-4 overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ğŸ“ è¿‘æœŸç•°å‹• (æœ€å¤š 50 ç­†)</h3>
            <div id="logs-container" class="space-y-3">
                <p class="text-center text-gray-500 py-10">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <!-- 4. è£½ç¢¼é é¢ -->
        <div id="view-create" class="hidden p-4">
            <div class="bg-white p-6 rounded-xl shadow-xl text-center space-y-6">
                <h3 class="text-2xl font-bold text-indigo-600">ğŸ–¨ï¸ æ¨™ç±¤è£½ä½œèˆ‡åˆ—å°</h3>
                
                <input
                    type="text"
                    id="new-code"
                    placeholder="è«‹è¼¸å…¥å•†å“ç·¨è™Ÿ (SKU)"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg text-center font-mono text-lg focus:border-indigo-500 transition"
                />

                <button 
                    onclick="makeQR()"
                    class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-md transition"
                >
                    ç”Ÿæˆ QR Code
                </button>

                <div class="flex justify-center mt-6 print-area">
                    <div class="p-4 bg-white border-2 border-dashed border-gray-300 rounded-xl shadow-inner">
                        <div id="qrcode-display-canvas" class="flex items-center justify-center w-[150px] h-[150px]">
                            <p class="text-sm text-gray-400">é»æ“Šç”Ÿæˆï¼Œå³å¯åœ¨æ­¤è™•é¡¯ç¤º</p>
                        </div>
                    </div>
                </div>

                <button 
                    onclick="window.print()"
                    class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 rounded-xl shadow-md transition mt-4 print:hidden"
                >
                    åˆ—å°æ­¤æ¨™ç±¤
                </button>
            </div>
        </div>
    </main>

    <!-- Footer Navigation -->
    <nav class="flex-shrink-0 flex justify-around items-center bg-white border-t border-gray-200 shadow-xl p-2">
        <button class="nav-btn flex flex-col items-center justify-center p-2 transition duration-200 text-indigo-600" onclick="switchView('scan')" data-view="scan">
            <span class="text-2xl">ğŸ“·</span>
            <span class="text-xs font-medium mt-1">æƒæå…¥åº«</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center p-2 transition duration-200 text-gray-500 hover:text-indigo-400" onclick="switchView('list')" data-view="list">
            <span class="text-2xl">ğŸ“¦</span>
            <span class="text-xs font-medium mt-1">åº«å­˜åˆ—è¡¨</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center p-2 transition duration-200 text-gray-500 hover:text-indigo-400" onclick="switchView('logs')" data-view="logs">
            <span class="text-2xl">ğŸ“</span>
            <span class="text-xs font-medium mt-1">æ­·å²ç´€éŒ„</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center p-2 transition duration-200 text-gray-500 hover:text-indigo-400" onclick="switchView('create')" data-view="create">
            <span class="text-2xl">ğŸ·ï¸</span>
            <span class="text-xs font-medium mt-1">æ¨™ç±¤è£½ç¢¼</span>
        </button>
    </nav>
</div>

<!-- æ¨¡æ…‹æ¡† (å•†å“è©³æƒ…èˆ‡ç·¨è¼¯) -->
<div id="detail-modal" class="fixed inset-0 z-50 bg-black bg-opacity-70 transition-opacity duration-300 opacity-0 pointer-events-none flex justify-center items-end" onclick="if(event.target.id === 'detail-modal') closeDetailModal()">
    <div id="modal-content" class="bg-gray-100 w-full max-w-md h-[90vh] rounded-t-2xl shadow-2xl flex flex-col transition-transform duration-300 translate-y-full">
        <div class="flex-shrink-0 p-4 bg-white rounded-t-2xl shadow-lg flex justify-between items-center border-b">
            <h2 id="modal-title" class="text-xl font-bold text-gray-800 truncate">å•†å“è©³æƒ…</h2>
            <button onclick="closeDetailModal()" class="text-3xl font-light text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        
        <div class="overflow-y-auto p-4 space-y-4 flex-grow">
            
            <!-- åŸºæœ¬è³‡è¨Šå¡ç‰‡ -->
            <div class="bg-white p-5 rounded-xl shadow-md space-y-3">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">åŸºæœ¬è³‡è¨Šèˆ‡ç·¨è¼¯</h3>
                
                <p class="text-sm text-gray-500 font-mono truncate">æ–™è™Ÿ (ID): <span id="detail-id" class="text-gray-800 font-bold">---</span></p>

                <div>
                    <label class="text-sm font-medium text-gray-600 block mb-1">å“å</label>
                    <input type="text" id="detail-name" onchange="updateDetailInfo()"
                        placeholder="è¼¸å…¥å•†å“åç¨±"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:border-indigo-500"
                    />
                </div>

                <div>
                    <label class="text-sm font-medium text-gray-600 block mb-1">å­˜æ”¾ä½ç½®</label>
                    <input type="text" id="detail-location" onchange="updateDetailInfo()"
                        placeholder="ä¾‹å¦‚: Aæ¶-3å±¤"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:border-indigo-500"
                    />
                </div>
                
                <p class="text-sm text-gray-500">æœ€å¾Œå…¥åº«æ—¥: <span id="detail-inbound-date" class="text-gray-800">---</span></p>
            </div>
            
            <!-- åº«å­˜èª¿æ•´å¡ç‰‡ -->
            <div class="bg-white p-5 rounded-xl shadow-md space-y-3">
                <h3 class="text-lg font-semibold text-gray-700">æ‰‹å‹•èª¿æ•´åº«å­˜</h3>
                <div class="flex items-center justify-between bg-indigo-50 p-3 rounded-lg">
                    <span class="text-indigo-700 font-medium">èª¿æ•´ç‚ºæ­¤æ•¸é‡:</span>
                    <input type="number" id="detail-qty-input" value="0" min="0" inputmode="numeric"
                        class="w-24 p-2 border-2 border-indigo-300 rounded-lg text-center font-bold text-xl"
                    />
                </div>
                
                <button onclick="handleManualUpdate()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition mt-2">
                    å„²å­˜ä¸¦èª¿æ•´åº«å­˜
                </button>
            </div>

            <!-- æ­·å²ç´€éŒ„å¡ç‰‡ -->
            <div class="bg-white p-5 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">ğŸšš é€²å‡ºè²¨æ­·å²ç´€éŒ„</h3>
                <ul id="detail-history-list" class="space-y-2">
                    <li class="text-center text-gray-500">è¼‰å…¥ä¸­...</li>
                </ul>
            </div>

        </div>
    </div>
</div>

<!-- éŒ¯èª¤è¨Šæ¯æç¤º -->
<div id="error-banner" class="hidden" onclick="this.style.display='none'"></div>

</body>
</html>
