<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>çµ‚æ¥µåº«å­˜ç³»çµ± V4.2 - ç™»å…¥å¼·åˆ¶ç‰ˆ</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">

    <!-- Firebase Modular SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, updateDoc, setDoc, query, orderBy, serverTimestamp, runTransaction, getDoc, where, limit, FieldValue } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        
        // --- 1. å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ– ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Firebase Configuration (Using provided or Canvas config)
        let firebaseConfig = {
            apiKey: "AIzaSyAUgk7DGfnCCt1-cTAhvD2Se4YZQEoXUE8",
            authDomain: "qr-inventory-2e995.firebaseapp.com",
            projectId: "qr-inventory-2e995",
            storageBucket: "qr-inventory-2e995.firebasestorage.app",
            messagingSenderId: "1041449207118",
            appId: "1:1041449207118:web:d8c66fa15024471f0d0a1f",
            measurementId: "G-YGQYMSS6E3"
        };
        try {
            const canvasConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            if (Object.keys(canvasConfig).length > 0) {
                firebaseConfig = canvasConfig;
            }
        } catch(e) {
            console.error("Failed to parse __firebase_config, using default.", e);
        }
        
        // const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // REMOVED: No more auto/token login

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let html5QrCode; 
        
        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
        let currentItem = { id: null, name: '', qty: 0, location: '' };
        let allInventoryData = [];
        let currentView = 'scan';
        let userRole = 'unknown'; // 'unknown', 'staff', 'manager'

        // è¼”åŠ©å‡½å¼
        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'è¼‰å…¥ä¸­...';
            return timestamp.toDate().toLocaleString('zh-TW', { hour12: false });
        };
        const vibrate = (pattern) => { if (navigator.vibrate) navigator.vibrate(pattern); };
        const setFlashMessage = (message, isSuccess = false) => {
            const banner = document.getElementById('error-banner');
            banner.innerText = message;
            banner.className = `fixed bottom-20 left-1/2 -translate-x-1/2 z-50 p-3 text-white rounded-lg shadow-2xl max-w-xs w-full text-sm text-center animate-pulse transition duration-300 cursor-pointer ${isSuccess ? 'bg-green-600' : 'bg-red-600'}`;
            banner.style.display = 'block';
            setTimeout(() => banner.style.display = 'none', 5000); // FIX: å»¶é•·é¡¯ç¤ºæ™‚é–“
        };
        
        // --- 2. Firebase & Auth å•Ÿå‹• ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // ç™»å…¥é‚è¼¯
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // FIX 1: ç¢ºä¿æ‰€æœ‰ç™»å…¥çš„ç”¨æˆ¶éƒ½æœ‰æ¬Šé™ï¼Œä¸¦æª¢æŸ¥è§’è‰²
                        userId = user.uid;
                        // ä»»ä½•é€é Email/Password ç™»å…¥çš„ç”¨æˆ¶ï¼Œé è¨­éƒ½æ˜¯ staffï¼Œç„¶å¾Œå†æª¢æŸ¥æ˜¯å¦ç‚º manager
                        await fetchAndSetUserRole(user.uid, false); 
                        isAuthReady = true;
                        
                        document.getElementById('role-display').innerText = `è§’è‰²: ${userRole === 'manager' ? 'ç®¡ç†å“¡' : 'æ“ä½œå“¡'}`;
                        document.getElementById('user-id-display').innerText = `ID: ${userId.substring(0, 8)}...`;
                        document.getElementById('status-dot').className = 'w-3 h-3 rounded-full bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.8)]';
                        
                        // é—œé–‰ç™»å…¥ä»‹é¢ä¸¦å•Ÿå‹•ä¸»åŠŸèƒ½
                        closeLoginModal();
                        setupFirestoreListeners();
                        startCamera();
                        
                        // æ ¹æ“šæ¬Šé™èª¿æ•´ UI
                        updateUIPermissions();
                    } else {
                        // FIX 2: ç§»é™¤æ‰€æœ‰åŒ¿åç™»å…¥é‚è¼¯ï¼Œå¼·åˆ¶é¡¯ç¤ºç™»å…¥ä»‹é¢
                        userId = null;
                        isAuthReady = false;
                        document.getElementById('role-display').innerText = `è§’è‰²: æœªç™»å…¥`;
                        document.getElementById('user-id-display').innerText = `ID: N/A`;
                        document.getElementById('status-dot').className = 'w-3 h-3 rounded-full bg-red-400';
                        // é–å®š UI
                        updateUIPermissions(true); 
                        showLoginModal();
                        stopCamera();
                    }
                });
            } catch (e) {
                console.error("Firebase Init Failed:", e);
                setFlashMessage("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ã€‚");
                showLoginModal(); 
            }
        }
        
        /**
         * æ ¹æ“š UID ç²å–ç”¨æˆ¶è§’è‰²ï¼Œä¸¦è¨­å®šå…¨åŸŸ userRole
         * @param {string} uid ç”¨æˆ¶ UID
         * @param {boolean} isAnonymous (Not used anymore, kept for signature consistency)
         */
        async function fetchAndSetUserRole(uid) {
            
            // é è¨­ç‚º Staffï¼Œå› ç‚ºç”¨æˆ¶å·²ç¶“é€šé Email/Password ç™»å…¥
            userRole = 'staff'; 
            
            // æª¢æŸ¥æ˜¯å¦ç‚º Manager
            const rolePath = `artifacts/${appId}/public/data/user_roles`;
            const roleRef = doc(db, rolePath, uid);

            try {
                const docSnap = await getDoc(roleRef);
                if (docSnap.exists() && docSnap.data().role === 'manager') {
                    userRole = 'manager';
                }
            } catch (e) {
                console.warn("Failed to fetch user role, defaulting to staff:", e);
                // å³ä½¿ç²å–å¤±æ•—ï¼Œä»ç„¶ä¿æŒ staff èº«ä»½
            }
        }

        /**
         * æ ¹æ“š userRole å•Ÿç”¨æˆ–ç¦ç”¨ UI å…ƒç´ 
         * @param {boolean} lockAll æ˜¯å¦é–å®šæ‰€æœ‰åŠŸèƒ½ (ç”¨æ–¼æœªç™»å…¥ç‹€æ…‹)
         */
        function updateUIPermissions(lockAll = false) {
            const isManager = userRole === 'manager' && !lockAll;
            const isLoggedOut = lockAll;
            
            // é–å®šæ‰€æœ‰å°èˆªæŒ‰éˆ•
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.disabled = isLoggedOut;
                btn.classList.toggle('opacity-50', isLoggedOut);
            });

            // 1. å°èˆªåˆ—æŒ‰éˆ• (è£½ç¢¼)
            const createBtn = document.querySelector('.nav-btn[data-view="create"]');
            if (createBtn) createBtn.disabled = !isManager && !isLoggedOut;
            if (createBtn) createBtn.classList.toggle('opacity-50', !isManager);

            // 2. è©³æƒ…æ¨¡æ…‹æ¡†çš„ç·¨è¼¯åŠŸèƒ½ (ç¢ºä¿æŒ‰éˆ•å­˜åœ¨)
            const manualInboundBtn = document.getElementById('handle-manual-inbound-btn'); 
            const updateDetailBtn = document.getElementById('update-detail-btn');
            const manualAdjustBtn = document.getElementById('handle-manual-update-btn');
            
            if (updateDetailBtn) updateDetailBtn.disabled = !isManager;
            if (manualAdjustBtn) manualAdjustBtn.disabled = !isManager;
            if (manualInboundBtn) manualInboundBtn.disabled = !isManager;
            
            // 3. æƒæé é¢çš„æ“ä½œæŒ‰éˆ•
            const stockButtons = document.querySelectorAll('.stock-operation-button');
            stockButtons.forEach(btn => btn.disabled = isLoggedOut);


            // 4. é¡¯ç¤ºæ¬Šé™ä¸è¶³æç¤º
            if (isLoggedOut) {
                 document.getElementById('view-scan').innerHTML = `<div class="p-6 text-center text-red-600 font-bold bg-white rounded-xl shadow-lg mt-10">ğŸ”’ è«‹ç™»å…¥ä»¥é–‹å§‹åº«å­˜æ“ä½œã€‚</div>`;
                 document.getElementById('view-list').innerHTML = `<div class="p-6 text-center text-red-600 font-bold bg-white rounded-xl shadow-lg mt-10">ğŸ”’ è«‹ç™»å…¥ä»¥æŸ¥çœ‹åº«å­˜ã€‚</div>`;
                 document.getElementById('view-logs').innerHTML = `<div class="p-6 text-center text-red-600 font-bold bg-white rounded-xl shadow-lg mt-10">ğŸ”’ è«‹ç™»å…¥ä»¥æŸ¥çœ‹ç´€éŒ„ã€‚</div>`;
            } else if (!isManager && currentView === 'create') {
                document.getElementById('view-create').innerHTML = `<div class="p-6 text-center text-red-600 font-bold bg-white rounded-xl shadow-lg mt-10">ğŸš« æ¬Šé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å“¡æ‰èƒ½é€²è¡Œæ¨™ç±¤è£½ç¢¼ã€‚</div>`;
            }
        }

        // --- 3. ç™»å…¥/ç™»å‡ºåŠŸèƒ½ ---
        window.showLoginModal = function() {
            // FIX: åœ¨æœªç™»å…¥æ™‚ï¼Œæ¨¡æ…‹æ¡†å¿…é ˆæ˜¯ä¸å¯é—œé–‰çš„
            document.getElementById('login-modal').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('login-modal-content').classList.remove('translate-y-full');
            document.getElementById('login-modal').setAttribute('data-closable', 'false'); // ç¦ç”¨å¤–éƒ¨é»æ“Šé—œé–‰
            document.querySelector('#login-modal button.text-sm').style.display = 'none'; // éš±è—å–æ¶ˆæŒ‰éˆ•
        }

        window.closeLoginModal = function() {
            // FIX: ç™»å…¥æˆåŠŸæ™‚ï¼Œæœƒå°‡ data-closable è¨­ç‚º true å…è¨±é—œé–‰
            const loginModal = document.getElementById('login-modal');
            const isClosable = loginModal.getAttribute('data-closable') === 'true';

            if (isClosable) {
                document.getElementById('login-modal-content').classList.add('translate-y-full');
                document.getElementById('login-modal').classList.add('opacity-0', 'pointer-events-none');
            }
        }
        
        window.handleEmailPasswordLogin = async function() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            console.log(`[AUTH] Attempting login for: ${email}`); // FIX: æ·»åŠ æ—¥èªŒ
            
            if (!email || !password) {
                setFlashMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶å’Œå¯†ç¢¼ã€‚");
                return;
            }

            try {
                // å˜—è©¦ç™»å…¥
                await signInWithEmailAndPassword(auth, email, password);
                
                // FIX: ç™»å…¥æˆåŠŸå¾Œï¼Œè¨­ç½®æˆåŠŸè¨Šæ¯ä¸¦ç«‹å³é—œé–‰æ¨¡æ…‹æ¡†
                setFlashMessage("âœ… ç™»å…¥æˆåŠŸï¼æ­£åœ¨è¼‰å…¥æ•¸æ“š...", true);
                document.getElementById('login-modal').setAttribute('data-closable', 'true'); // è¨­ç½®ç‚ºå¯é—œé–‰
                // onAuthStateChanged æœƒåœ¨èƒŒæ™¯å®Œæˆè§’è‰²æª¢æŸ¥ï¼Œä¸¦å‘¼å« closeLoginModal
                
            } catch (error) {
                console.error("Email/Password Login Failed:", error);
                // æª¢æŸ¥æ˜¯å¦æ˜¯ "user-not-found" æˆ– "wrong-password"
                const msg = error.code.includes('user-not-found') || error.code.includes('wrong-password') ? 
                            "ç™»å…¥å¤±æ•—ï¼šå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ã€‚" : 
                            "ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¸³è™Ÿç‹€æ…‹ã€‚";
                setFlashMessage(`âŒ ${msg}`, false);
            }
        }

        window.handleLogout = async function() {
            stopCamera();
            try {
                // FIX 1: ç™»å‡ºå¾Œï¼Œå¼·åˆ¶åˆ·æ–°é é¢ä»¥ç¢ºä¿UIå’Œç‹€æ…‹å®Œå…¨é‡ç½®åˆ°æœªç™»å…¥ç‹€æ…‹
                await signOut(auth);
                setFlashMessage("å·²ç™»å‡ºï¼Œæ­£åœ¨é‡è¼‰é é¢...", true);
                setTimeout(() => window.location.reload(), 500); // ç¢ºä¿ Firebase ç™»å‡ºå®Œæˆå¾Œå†é‡è¼‰
            } catch (error) {
                console.error("Logout Failed:", error);
                setFlashMessage("ç™»å‡ºå¤±æ•—ã€‚", false);
            }
        }


        // --- 4. Firestore å³æ™‚ç›£è½å™¨ ---
        function setupFirestoreListeners() {
            // ... (ä¿æŒä¸è®Š)
            const inventoryPath = `/artifacts/${appId}/users/${userId}/inventory_v4`;
            const logsPath = `/artifacts/${appId}/users/${userId}/logs_v4`;

            // åº«å­˜åˆ—è¡¨è¨‚é–±
            onSnapshot(collection(db, inventoryPath), (snapshot) => {
                allInventoryData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                renderList(allInventoryData);
            }, (error) => {
                console.error("Inventory Snapshot Error:", error);
                setFlashMessage("ç„¡æ³•è¼‰å…¥åº«å­˜æ•¸æ“šã€‚");
            });

            // æ“ä½œç´€éŒ„è¨‚é–± (æœ€å¤š 50 ç­†)
            const logsQuery = query(collection(db, logsPath), orderBy("timestamp", "desc"), limit(50));
            onSnapshot(logsQuery, (snapshot) => {
                renderLogs(snapshot.docs.map(doc => doc.data()));
            }, (error) => {
                console.error("Logs Snapshot Error:", error);
            });
        }

        // è¼”åŠ©å‡½å¼ï¼šå®‰å…¨æª¢æŸ¥éŒ¯èª¤æ˜¯å¦ç‚ºæ¬Šé™å•é¡Œ
        function isPermissionError(err) {
            // ç¢ºä¿ err.message å­˜åœ¨ä¸”æ˜¯å­—ä¸²ï¼Œé¿å… TypeError
            const message = err?.message || ''; 
            return err?.name === 'NotAllowedError' || message.includes('permission');
        }

        // è¼”åŠ©å‡½å¼ï¼šé›†ä¸­è™•ç†æœ€çµ‚çš„ç›¸æ©Ÿå•Ÿå‹•éŒ¯èª¤
        function handleFinalCameraError(err, scannerText) {
            console.error("Camera startup final error:", err);
            if (isPermissionError(err)) {
                if (scannerText) scannerText.innerText = "ğŸš¨ å•Ÿå‹•å¤±æ•—ï¼šè«‹æˆäºˆç›¸æ©Ÿæ¬Šé™ã€‚";
                setFlashMessage("ğŸš¨ å•Ÿå‹•å¤±æ•—ï¼šè«‹æˆäºˆç›¸æ©Ÿæ¬Šé™ã€‚", false);
            } else {
                if (scannerText) scannerText.innerText = `ğŸš¨ ç›¸æ©Ÿå•Ÿå‹•ç™¼ç”ŸéŒ¯èª¤: ${err.name || 'æœªçŸ¥éŒ¯èª¤'}ã€‚è«‹æª¢æŸ¥è¨­å‚™ã€‚`;
                setFlashMessage("ğŸš¨ ç›¸æ©Ÿå•Ÿå‹•ç™¼ç”ŸéŒ¯èª¤ã€‚", false);
            }
        }
        
        // --- 5. æƒæå™¨æ§åˆ¶ (å„ªåŒ–: ç¹é facingMode å”å•†ï¼Œç›´æ¥ä½¿ç”¨ Device ID å•Ÿå‹•) ---
        async function startCamera() {
            if (typeof window.Html5Qrcode === 'undefined' || !isAuthReady) {
                // åªæœ‰åœ¨ç™»å…¥å®Œæˆå¾Œæ‰å˜—è©¦å•Ÿå‹•ç›¸æ©Ÿ
                return;
            }
            if (!html5QrCode) html5QrCode = new window.Html5Qrcode("scanner-container");
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“åœ¨æƒæ
            if (html5QrCode.isScanning) {
                return;
            }

            const scannerText = document.querySelector('#scanner-container p');
            if (scannerText) scannerText.innerText = "æ­£åœ¨åµæ¸¬ç›¸æ©Ÿè¨­å‚™...";

            const qrboxFunction = (viewfinderWidth, viewfinderHeight) => {
                let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                let size = Math.floor(minEdge * 0.7);
                return { width: size, height: size };
            };

            const config = { fps: 10, qrbox: qrboxFunction };

            // FIX 3.1: æƒææˆåŠŸå¾Œï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºé‡è¤‡æƒæçš„ ID
            let lastScannedId = null;
            const onScanSuccess = (decodedText) => { 
                if (decodedText !== lastScannedId) {
                    lastScannedId = decodedText;
                    vibrate([50]); 
                    fetchItemData(decodedText);
                    
                    // å¯é¸: çŸ­æš«åœæ­¢æƒæä»¥é¿å…é€£çºŒéœ‡å‹•ï¼Œä½†é€™æœƒå¢åŠ å»¶é²
                    // setTimeout(() => { lastScannedId = null; }, 1500); 
                }
            };
            const onScanError = (errorMessage) => { /* å¿½ç•¥è©³ç´°éŒ¯èª¤è¨Šæ¯ä»¥ä¿æŒæ§åˆ¶å°æ¸…æ½” */ };
            
            try {
                const devices = await window.Html5Qrcode.getCameras();
                let targetId = null;
                let targetLabel = 'Default Camera';

                if (devices && devices.length) {
                    // 1. å„ªå…ˆé¸æ“‡å¾Œç½®é¡é ­ (åŒ…å« 'back', 'environment' ç­‰é—œéµå­—)
                    const environmentCam = devices.find(d => 
                        d.label.toLowerCase().includes('back') || 
                        d.label.toLowerCase().includes('environment')
                    );
                    
                    if (environmentCam) {
                        targetId = environmentCam.id;
                        targetLabel = environmentCam.label;
                    } else {
                        // 2. å¦å‰‡ä½¿ç”¨ç¬¬ä¸€å€‹æ‰¾åˆ°çš„è¨­å‚™
                        targetId = devices[0].id;
                        targetLabel = devices[0].label;
                    }
                    
                    if (scannerText) scannerText.innerText = `åµæ¸¬åˆ° ${targetLabel}ï¼Œå˜—è©¦å•Ÿå‹•...`;

                    // 3. ä½¿ç”¨ç‰¹å®šçš„ Device ID å•Ÿå‹•ï¼Œé€™æ˜¯æœ€å¯é çš„æ–¹å¼
                    await html5QrCode.start(
                        targetId, // ä½¿ç”¨ deviceId string
                        config, 
                        onScanSuccess, 
                        onScanError
                    );

                    if (scannerText) scannerText.innerText = "ç›¸æ©Ÿå·²å•Ÿå‹•ï¼Œè«‹å°æº– QR Code";
                    
                } else {
                    // æ‰¾ä¸åˆ°ä»»ä½•ç›¸æ©Ÿ
                    if (scannerText) scannerText.innerText = "ğŸš¨ æ‰¾ä¸åˆ°ä»»ä½•ç›¸æ©Ÿè¨­å‚™ã€‚";
                    setFlashMessage("ğŸš¨ æ‰¾ä¸åˆ°ç›¸æ©Ÿã€‚è«‹æª¢æŸ¥æ¬Šé™ã€‚", false);
                }
                
            } catch (err) {
                // æœ€çµ‚éŒ¯èª¤è™•ç†
                handleFinalCameraError(err, scannerText);
            }
        }


        function stopCamera() {
            if (html5QrCode && html5QrCode.isScanning) {
                const scannerText = document.querySelector('#scanner-container p');
                if (scannerText) scannerText.innerText = "æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...";
                html5QrCode.stop().catch(err => console.error("Camera stop failed:", err));
            }
        }

        // --- 6. æƒæçµæœè™•ç† (ä¿æŒä¸è®Š) ---
        async function fetchItemData(id) {
            // FIX 3.2: ç¢ºä¿åªæœ‰ç•¶ ID æ”¹è®Šæ™‚æ‰é‡æ–°è¼‰å…¥æ•¸æ“š
            if (currentItem.id === id) { 
                return; 
            }
            
            const docRef = doc(db, `/artifacts/${appId}/users/${userId}/inventory_v4`, id);
            
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    currentItem = { id: docSnap.id, ...docSnap.data() };
                } else {
                    currentItem = { id: id, name: '', qty: 0, location: '' };
                }
                updateScanViewUI();
                setFlashMessage(docSnap.exists() ? `æˆåŠŸè¼‰å…¥å•†å“: ${currentItem.name || 'æœªå‘½å'}` : `åµæ¸¬åˆ°æ–°å•†å“ ID: ${currentItem.id}`, true);
            } catch (e) {
                console.error("Fetch Item Error:", e);
                setFlashMessage("è®€å–å•†å“è³‡è¨Šå¤±æ•—ã€‚");
            }
        }

        function updateScanViewUI() {
            document.getElementById('res-id').innerText = currentItem.id || "---";
            document.getElementById('res-name').value = currentItem.name || "";
            document.getElementById('res-name').placeholder = currentItem.id ? "è¼¸å…¥å•†å“åç¨± (å¤±ç„¦å¾Œå„²å­˜)" : "æ–°å•†å“ - è«‹å‘½å";
            document.getElementById('res-qty').innerText = currentItem.qty;
            document.getElementById('op-amount').value = 1; 

            if (currentView !== 'scan') {
                window.switchView('scan');
            }
        }

        function handleNameUpdate() {
            if (!currentItem.id || !db) return;
            const newName = document.getElementById('res-name').value.trim();
            if (newName === currentItem.name) return;
            
            if (newName === '' && currentItem.qty === 0 && currentItem.name === '') return;

            currentItem.name = newName;
            
            setDoc(doc(db, `/artifacts/${appId}/users/${userId}/inventory_v4`, currentItem.id), { name: newName, updatedAt: serverTimestamp() }, { merge: true })
                .then(() => setFlashMessage("åç¨±æ›´æ–°æˆåŠŸï¼", true))
                .catch(e => {
                    console.error("Name update failed:", e);
                    setFlashMessage("åç¨±æ›´æ–°å¤±æ•—ï¼");
                });
        }

        // --- 7. åº«å­˜æ“ä½œ (å…¥åº«/å‡ºåº«) (ä¿æŒä¸è®Š) ---
        async function handleStock(direction) {
            if (!currentItem.id || !db || !userId || !isAuthReady) {
                return setFlashMessage("è«‹å…ˆæƒæå•†å“ ID æˆ–å®Œæˆç™»å…¥ã€‚", false);
            }
            // FIX 2: ç§»é™¤å° userRole === 'unknown' çš„æª¢æŸ¥ï¼Œå› ç‚ºæ‰€æœ‰ç™»å…¥çš„ç”¨æˆ¶éƒ½æ˜¯ staff æˆ– manager
            
            const opAmountEl = document.getElementById('op-amount');
            const amount = parseInt(opAmountEl.value);
            
            if (isNaN(amount) || amount <= 0) return setFlashMessage("æ•¸é‡å¿…é ˆå¤§æ–¼ 0");

            const inventoryPath = `/artifacts/${appId}/users/${userId}/inventory_v4`;
            const logsPath = `/artifacts/${appId}/users/${userId}/logs_v4`;
            const itemRef = doc(db, inventoryPath, currentItem.id);
            const change = amount * direction;

            try {
                await runTransaction(db, async (transaction) => {
                    const itemDoc = await transaction.get(itemRef);
                    const currentQty = itemDoc.exists() ? itemDoc.data().qty : 0;
                    const newQty = currentQty + change;

                    if (newQty < 0) throw new Error("åº«å­˜ä¸è¶³ï¼Œç„¡æ³•å‡ºåº«ï¼");

                    const name = document.getElementById('res-name').value.trim() || 'æœªå‘½å';
                    const isNewItem = !itemDoc.exists();
                    
                    const updateFields = {
                        name: name,
                        qty: newQty,
                        updatedAt: serverTimestamp(),
                        id: currentItem.id,
                    };
                    
                    if (isNewItem) {
                         updateFields.createdAt = serverTimestamp();
                         updateFields.location = ''; 
                    }

                    if (direction > 0) updateFields.lastInboundDate = serverTimestamp();

                    transaction.set(itemRef, updateFields, { merge: true });

                    const logRef = doc(collection(db, logsPath));
                    transaction.set(logRef, {
                        productId: currentItem.id,
                        productName: name,
                        action: direction > 0 ? "å…¥åº«" : "å‡ºåº«",
                        amount: amount,
                        timestamp: serverTimestamp(),
                    });
                    
                    currentItem.qty = newQty;
                });

                vibrate([50, 50]);
                setFlashMessage("æ“ä½œæˆåŠŸï¼åº«å­˜å·²æ›´æ–°ã€‚", true);
                opAmountEl.value = 1;
                document.getElementById('res-qty').innerText = currentItem.qty; 
            } catch (e) {
                setFlashMessage(e.message);
                vibrate([100, 100, 100]);
                console.error("Transaction failed:", e);
            }
        }

        // --- 7.5. æ‰‹å‹•å…¥åº«åŠŸèƒ½ (æ–°å¢) ---
        window.handleManualInbound = async function() {
             if (userRole !== 'manager') {
                 return setFlashMessage("æ¬Šé™ä¸è¶³ï¼šæ‚¨å¿…é ˆæ˜¯ç®¡ç†å“¡æ‰èƒ½æ‰‹å‹•å…¥åº«ã€‚", false);
            }
            
            const id = document.getElementById('detail-qty-input-id').value;
            const inboundQty = parseInt(document.getElementById('manual-inbound-qty').value);
            
            if (!id || isNaN(inboundQty) || inboundQty <= 0) {
                 return setFlashMessage("ID æˆ–å…¥åº«æ•¸é‡ç„¡æ•ˆï¼", false);
            }

            const inventoryPath = `/artifacts/${appId}/users/${userId}/inventory_v4`;
            const logsPath = `/artifacts/${appId}/users/${userId}/logs_v4`;
            const itemRef = doc(db, inventoryPath, id);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const itemDoc = await transaction.get(itemRef);
                    const currentQty = itemDoc.exists() ? itemDoc.data().qty : 0;
                    const newQty = currentQty + inboundQty;
                    
                    const name = itemDoc.exists() ? itemDoc.data().name : 'æœªå‘½å';
                    const isNewItem = !itemDoc.exists();

                    const updateFields = {
                        name: name,
                        qty: newQty,
                        updatedAt: serverTimestamp(),
                        lastInboundDate: serverTimestamp(),
                        id: id,
                    };

                    if (isNewItem) {
                         updateFields.createdAt = serverTimestamp();
                         updateFields.location = ''; 
                    }
                    
                    transaction.set(itemRef, updateFields, { merge: true });

                    const logRef = doc(collection(db, logsPath));
                    transaction.set(logRef, {
                        productId: id,
                        productName: name,
                        action: "æ‰‹å‹•å…¥åº«",
                        amount: inboundQty,
                        timestamp: serverTimestamp(),
                    });
                });

                vibrate([50, 50, 50]);
                setFlashMessage(`æ‰‹å‹•å…¥åº« ${inboundQty} ä»¶æˆåŠŸï¼`, true);
                
                // æ¸…ç©ºæ¬„ä½ä¸¦é—œé–‰æ¨¡æ…‹æ¡†
                document.getElementById('detail-qty-input-id').value = '';
                document.getElementById('manual-inbound-qty').value = 1;
                window.closeManualInboundModal();

            } catch (e) {
                setFlashMessage(e.message);
                console.error("Manual Inbound Error:", e);
            }
        }
        
        // --- 8. åˆ—è¡¨å’Œç´€éŒ„æ¸²æŸ“ (ä¿æŒä¸è®Š) ---
        function renderList(data) {
            const container = document.getElementById('list-container');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (!isAuthReady) {
                 // Prevent rendering when not authenticated
                 return;
            }

            const filteredData = data
                .filter(item =>
                    item.id.toLowerCase().includes(searchTerm) ||
                    (item.name || '').toLowerCase().includes(searchTerm)
                )
                .sort((a, b) => b.qty - a.qty);

            if(filteredData.length === 0) {
                return container.innerHTML = `<p class="text-center text-gray-500 py-10">${searchTerm ? "ç„¡ç¬¦åˆæ¢ä»¶çš„å•†å“" : "åº«å­˜åˆ—è¡¨ç‚ºç©º..."}</p>`;
            }

            container.innerHTML = filteredData.map(item => {
                const isLowStock = item.qty <= 5 && item.qty > 0; 
                const isEmpty = item.qty === 0; 
                const dateStr = item.lastInboundDate ? formatTimestamp(item.lastInboundDate).split(' ')[0] : 'ç„¡ç´€éŒ„';
                
                let colorClass = 'text-gray-800';
                let borderClass = 'border-gray-300';

                if (isEmpty) {
                    colorClass = 'text-red-500';
                    borderClass = 'border-red-500';
                } else if (isLowStock) {
                    colorClass = 'text-orange-500';
                    borderClass = 'border-orange-500';
                } else {
                    colorClass = 'text-green-600';
                    borderClass = 'border-green-500';
                }

                return `
                    <div onclick="window.showDetailModal('${item.id}')"
                        class="flex justify-between items-center p-4 bg-white rounded-xl shadow-md cursor-pointer hover:shadow-lg transition border-l-4 ${borderClass}">
                        <div class="flex flex-col flex-1 truncate">
                            <span class="font-semibold text-gray-800 truncate">${item.name || "æœªå‘½å"}</span>
                            <span class="text-xs text-gray-500 font-mono">ID: ${item.id}</span>
                            <span class="text-xs text-gray-500 mt-1">ä½ç½®: ${item.location || 'ç„¡'} | æœ€å¾Œå…¥åº«: ${dateStr}</span>
                        </div>
                        <div class="text-3xl font-extrabold ${colorClass}">
                            ${item.qty}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLogs(logsData) {
             if (!isAuthReady) {
                 // Prevent rendering when not authenticated
                 return;
            }
            const container = document.getElementById('logs-container');
            if (logsData.length === 0) {
                return container.innerHTML = `<p class="text-center text-gray-500 py-10">ç„¡æ­·å²ç´€éŒ„</p>`;
            }

            container.innerHTML = logsData.map(log => {
                const isOutbound = log.action.includes('å‡ºåº«');
                const color = isOutbound ? 'text-red-600' : 'text-green-600';
                const sign = isOutbound ? '-' : '+';
                const time = formatTimestamp(log.timestamp);

                return `
                    <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm">
                        <div class="flex flex-col flex-1 truncate">
                            <span class="font-medium text-gray-800 truncate">${log.productName}</span>
                            <span class="text-xs text-gray-500">${time}</span>
                        </div>
                        <div class="text-right flex-shrink-0 ml-4">
                            <span class="font-extrabold text-lg ${color}">${sign}${log.amount}</span>
                            <span class="block text-xs text-gray-600">${log.action}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- 9. å•†å“è©³æƒ…æ¨¡æ…‹æ¡†é‚è¼¯ (åŠ å…¥æ¬Šé™æª¢æŸ¥) ---
        window.showDetailModal = async function(id) {
            if (!isAuthReady) return setFlashMessage("è«‹å…ˆç™»å…¥ã€‚", false);

            const modal = document.getElementById('detail-modal');
            modal.classList.add('opacity-100', 'pointer-events-auto');
            document.getElementById('modal-content').classList.remove('translate-y-full');
            
            // è¼‰å…¥å•†å“åŸºæœ¬æ•¸æ“š (ä¿æŒä¸è®Š)
            const docRef = doc(db, `/artifacts/${appId}/users/${userId}/inventory_v4`, id);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) return setFlashMessage("å•†å“ä¸å­˜åœ¨ã€‚");
            
            const d = docSnap.data();
            const dateStr = d.lastInboundDate ? formatTimestamp(d.lastInboundDate).split(' ')[0] : 'ç„¡ç´€éŒ„';

            document.getElementById('modal-title').innerText = d.name || "å•†å“è©³æƒ…";
            document.getElementById('detail-id').innerText = d.id;
            document.getElementById('detail-inbound-date').innerText = dateStr;
            document.getElementById('detail-name').value = d.name || "";
            document.getElementById('detail-location').value = d.location || "";
            document.getElementById('detail-qty-input').value = d.qty;
            document.getElementById('detail-qty-input').setAttribute('data-item-id', id);
            
            // æ¬Šé™æ§åˆ¶ï¼šç®¡ç†å“¡æ‰èƒ½ç·¨è¼¯/èª¿æ•´
            const isManager = userRole === 'manager';
            document.getElementById('detail-name').readOnly = !isManager;
            document.getElementById('detail-location').readOnly = !isManager;
            document.getElementById('detail-qty-input').readOnly = !isManager;
            
            const adminButtons = document.querySelectorAll('.manager-only-button');
            adminButtons.forEach(btn => btn.disabled = !isManager);

            if (!isManager) {
                document.getElementById('admin-warning').style.display = 'block';
            } else {
                document.getElementById('admin-warning').style.display = 'none';
            }
            
            // è¼‰å…¥æ­·å²ç´€éŒ„ (ä¿æŒä¸è®Š)
            const logsPath = `/artifacts/${appId}/users/${userId}/logs_v4`;
            const detailLogsQuery = query(collection(db, logsPath), where("productId", "==", id), orderBy("timestamp", "desc"), limit(20));
            const historyList = document.getElementById('detail-history-list');
            historyList.innerHTML = `<li class="text-center text-gray-500 py-4">è¼‰å…¥ä¸­...</li>`;
            
            const snapshot = await getDocs(detailLogsQuery); 
            
            if (snapshot.empty) {
                historyList.innerHTML = `<li class="text-center text-gray-500 py-4">ç„¡æ­·å²ç´€éŒ„</li>`;
            } else {
                historyList.innerHTML = snapshot.docs.map(logDoc => {
                    const log = logDoc.data();
                    const time = formatTimestamp(log.timestamp);
                    const isOutbound = log.action.includes('å‡ºåº«');
                    const color = isOutbound ? 'text-red-500' : 'text-green-500';
                    const sign = isOutbound ? '-' : '+';
                    
                    return `
                        <li class="flex justify-between items-center text-sm border-b last:border-b-0 py-2">
                            <span class="text-gray-600 font-medium">${log.action}</span>
                            <div class="text-right">
                                <span class="font-bold ${color}">${sign}${log.amount}</span>
                                <span class="block text-xs text-gray-400">${time}</span>
                            </div>
                        </li>
                    `;
                }).join('');
            }
        }

        window.closeDetailModal = function() {
            document.getElementById('modal-content').classList.add('translate-y-full');
            document.getElementById('detail-modal').classList.remove('opacity-100', 'pointer-events-none');
        }
        
        window.updateDetailInfo = async function() {
            if (userRole !== 'manager') {
                 return setFlashMessage("æ¬Šé™ä¸è¶³ï¼šæ‚¨å¿…é ˆæ˜¯ç®¡ç†å“¡æ‰èƒ½ç·¨è¼¯è³‡è¨Šã€‚", false);
            }
            // ... (ä¿æŒä¸è®Š)
            const id = document.getElementById('detail-qty-input').getAttribute('data-item-id');
            const name = document.getElementById('detail-name').value.trim();
            const location = document.getElementById('detail-location').value.trim();
            
            if (!id || !db) return;
            
            try {
                await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/inventory_v4`, id), { 
                    name: name, 
                    location: location, 
                    updatedAt: serverTimestamp() 
                });
                setFlashMessage("åŸºæœ¬è³‡è¨Šæ›´æ–°æˆåŠŸï¼", true);
            } catch (e) {
                console.error("Update Detail Error:", e);
                setFlashMessage("æ›´æ–°å¤±æ•—ã€‚");
            }
        }

        window.handleManualUpdate = async function() {
             if (userRole !== 'manager') {
                 return setFlashMessage("æ¬Šé™ä¸è¶³ï¼šæ‚¨å¿…é ˆæ˜¯ç®¡ç†å“¡æ‰èƒ½æ‰‹å‹•èª¿æ•´åº«å­˜ã€‚", false);
            }
            // ... (ä¿æŒä¸è®Š)
            const inputEl = document.getElementById('detail-qty-input');
            const id = inputEl.getAttribute('data-item-id');
            const newQty = parseInt(inputEl.value);
            
            if (!id || isNaN(newQty) || newQty < 0) return setFlashMessage("æ•¸é‡ç„¡æ•ˆæˆ– ID ç¼ºå¤±ã€‚");

            const inventoryPath = `/artifacts/${appId}/users/${userId}/inventory_v4`;
            const logsPath = `/artifacts/${appId}/users/${userId}/logs_v4`;
            const itemRef = doc(db, inventoryPath, id);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const itemDoc = await transaction.get(itemRef);
                    const oldQty = itemDoc.exists() ? itemDoc.data().qty : 0;
                    const diff = newQty - oldQty;

                    if (diff === 0) throw new Error("æ•¸é‡æœªè®Šæ›´");

                    const action = diff > 0 ? "æ‰‹å‹•èª¿æ•´-å…¥åº«" : "æ‰‹å‹•èª¿æ•´-å‡ºåº«"; // å€åˆ†èª¿æ•´é¡å‹
                    const amount = Math.abs(diff);
                    const name = document.getElementById('detail-name').value.trim() || 'æœªå‘½å';
                    
                    transaction.update(itemRef, { 
                        qty: newQty, 
                        name: name,
                        updatedAt: serverTimestamp() 
                    });

                    const logRef = doc(collection(db, logsPath));
                    transaction.set(logRef, {
                        productId: id,
                        productName: name,
                        action: action,
                        amount: amount,
                        timestamp: serverTimestamp(),
                    });
                });

                vibrate([50, 50, 50]);
                setFlashMessage("åº«å­˜èª¿æ•´æˆåŠŸï¼", true);
                window.showDetailModal(id); 
            } catch (e) {
                setFlashMessage(e.message);
                console.error("Manual Adjust Error:", e);
            }
        }

        // --- 9.5. æ‰‹å‹•å…¥åº«æ¨¡æ…‹æ¡†æ§åˆ¶ ---
        window.showManualInboundModal = function() {
            if (userRole !== 'manager') {
                 return setFlashMessage("æ¬Šé™ä¸è¶³ï¼šæ‚¨å¿…é ˆæ˜¯ç®¡ç†å“¡æ‰èƒ½æ‰‹å‹•å…¥åº«ã€‚", false);
            }
            document.getElementById('manual-inbound-modal').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('manual-inbound-modal-content').classList.remove('translate-y-full');
            document.getElementById('detail-qty-input-id').focus();
        }

        window.closeManualInboundModal = function() {
            document.getElementById('manual-inbound-modal-content').classList.add('translate-y-full');
            document.getElementById('manual-inbound-modal').classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('detail-qty-input-id').value = '';
            document.getElementById('manual-inbound-qty').value = 1;
        }

        
        // --- 10. è¼”åŠ©åŠŸèƒ½ ---
        window.switchView = function(view) {
            
            if (!isAuthReady) {
                return setFlashMessage("è«‹å…ˆç™»å…¥ã€‚", false);
            }

            // æ¬Šé™æª¢æŸ¥ï¼šåªæœ‰ç®¡ç†å“¡æ‰èƒ½é€²å…¥è£½ç¢¼é é¢
            if (view === 'create' && userRole !== 'manager') {
                document.getElementById('view-create').innerHTML = `<div class="p-6 text-center text-red-600 font-bold bg-white rounded-xl shadow-lg mt-10">ğŸš« æ¬Šé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å“¡æ‰èƒ½é€²è¡Œæ¨™ç±¤è£½ç¢¼ã€‚</div>`;
                // ç¹¼çºŒåˆ‡æ›é é¢ï¼Œä½†é¡¯ç¤ºæ¬Šé™ä¸è¶³è¨Šæ¯
            }

            currentView = view; 
            const mainContent = document.getElementById('main-content-scroll');
            const views = { 'scan': 'view-scan', 'list': 'view-list', 'logs': 'view-logs', 'create': 'view-create' };
            
            if (view === 'scan') {
                mainContent.classList.add('overflow-hidden'); 
                mainContent.classList.remove('overflow-y-auto');
            } else {
                mainContent.classList.add('overflow-y-auto');
                mainContent.classList.remove('overflow-hidden');
            }

            Object.keys(views).forEach(v => {
                document.getElementById(views[v]).classList.add('hidden');
            });
            document.getElementById(views[view]).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-indigo-600'));
            document.querySelector(`.nav-btn[data-view="${view}"]`).classList.add('text-indigo-600');

            if (view === 'scan') {
                currentItem = { id: null, name: '', qty: 0, location: '' };
                updateScanViewUI();
                setTimeout(startCamera, 300);
            } else {
                stopCamera();
                if (view === 'list') renderList(allInventoryData);
            }
        }
        
        // ... (å…¶ä»–è¼”åŠ©åŠŸèƒ½ä¿æŒä¸è®Š)

        window.filterList = function() {
            renderList(allInventoryData);
        }

        window.fillMaxStock = function() {
            const currentQty = parseInt(document.getElementById('res-qty').innerText) || 0;
            document.getElementById('op-amount').value = currentQty;
            vibrate([50]);
        }
        
        window.makeQR = function() {
            if (userRole !== 'manager') {
                return setFlashMessage("æ¬Šé™ä¸è¶³ï¼šæ‚¨å¿…é ˆæ˜¯ç®¡ç†å“¡æ‰èƒ½è£½ç¢¼ã€‚", false);
            }

            vibrate([50]);
            const text = document.getElementById('new-code').value;
            if(!text) return;
            
            const qrcodeContainer = document.getElementById('qrcode-display-canvas');
            if (typeof window.QRCode !== 'undefined') {
                qrcodeContainer.innerHTML = '';
                new window.QRCode(qrcodeContainer, {
                    text: text,
                    width: 150,
                    height: 150,
                    colorDark : "#0f172a",
                    colorLight : "#ffffff",
                    correctLevel : window.QRCode.CorrectLevel.H
                });
            } else {
                setFlashMessage("QRCode å…ƒä»¶è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
            }
        }

        window.exportToExcel = function() {
            vibrate([50]);
            if (allInventoryData.length === 0) return setFlashMessage("æ²’æœ‰åº«å­˜æ•¸æ“šå¯åŒ¯å‡ºã€‚");

            const header = ["å•†å“ç·¨è™Ÿ (ID)", "å“å", "åº«å­˜æ•¸é‡", "å­˜æ”¾ä½ç½®", "æœ€å¾Œå…¥åº«æ—¥", "æ›´æ–°æ™‚é–“"].join(',');
            const csvRows = allInventoryData.map(item => {
                const lastInbound = item.lastInboundDate ? formatTimestamp(item.lastInboundDate) : '';
                const updatedAt = item.updatedAt ? formatTimestamp(item.updatedAt) : '';
                return [
                    `"${item.id}"`,
                    `"${item.name || 'æœªå‘½å'}"`,
                    item.qty,
                    `"${item.location || ''}"`,
                    `"${updatedAt}"`
                ].join(',');
            });

            const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + header + "\n" + csvRows.join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `inventory_export_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- 11. æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• ---
        document.addEventListener('DOMContentLoaded', initializeFirebase);

    </script>
    
    <!-- QR Code Core Libraries (Global) -->
    <script src="https://unpkg.com/html5-qrcode" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>

    <style>
        /* åŸºç¤æ¨£å¼å’Œ Tailwind è¦†è“‹ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb; /* ç°è‰²èƒŒæ™¯ */
            height: 100vh;
            height: 100dvh;
        }
        .app-wrapper {
            width: 100%;
            max-width: 480px;
            background-color: #f9fafb; /* æ·ºç° App èƒŒæ™¯ */
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 25px rgba(0,0,0,0.15);
        }
        /* Fix for Safari bottom padding */
        nav { padding-bottom: env(safe-area-inset-bottom); }

        /* ç›¸æ©Ÿå®¹å™¨ */
        #scanner-container video {
            object-fit: cover !important;
            width: 100% !important;
            height: 100% !important;
        }
        /* éš±è—åˆ—å°æŒ‰éˆ• */
        @media print {
            .print\\:hidden { display: none !important; }
            .print\\:block { display: block !important; }
            .print-area { margin: 0; box-shadow: none; border: none; }
        }
    </style>
</head>

<body class="flex justify-center overflow-hidden">

<div class="app-wrapper">
    <!-- Header -->
    <header class="flex-shrink-0 bg-indigo-700 text-white p-4 flex justify-between items-center shadow-lg">
        <h1 class="text-xl font-bold tracking-wider">ğŸ“¦ çµ‚æ¥µåº«å­˜ç³»çµ± V4.2</h1>
        <div class="flex items-center space-x-3">
            <div class="text-xs text-right">
                <span id="role-display" class="font-bold block">è§’è‰²: è¼‰å…¥ä¸­...</span>
                <span id="user-id-display" class="font-mono opacity-70">ID: è¼‰å…¥ä¸­...</span>
            </div>
            <div class="flex items-center space-x-2">
                 <button onclick="handleLogout()" class="text-white/80 hover:text-white transition text-sm py-1 px-2 rounded-lg bg-indigo-600/50">ç™»å‡º</button>
                 <div id="status-dot" class="w-3 h-3 rounded-full bg-red-400" title="é€£ç·šç‹€æ…‹"></div>
            </div>
        </div>
    </header>

    <!-- Content Area (Scrollable) -->
    <main id="main-content-scroll" class="flex-grow overflow-y-auto">
        
        <!-- 1. æƒæé é¢ (é è¨­é¡¯ç¤º) -->
        <div id="view-scan" class="h-full flex flex-col justify-start">
            
            <div class="p-2 space-y-2 flex-shrink-0 h-full flex flex-col">
                <!-- ç›¸æ©Ÿå®¹å™¨ï¼šä½¿ç”¨ flex-grow ä½”æ»¿æ‰€æœ‰å‰©é¤˜å‚ç›´ç©ºé–“ -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden border-4 border-indigo-500/50 flex-grow min-h-[100px] max-h-full">
                    <div id="scanner-container" class="w-full h-full bg-gray-900 flex items-center justify-center text-white text-lg">
                        <p>æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...</p>
                    </div>
                </div>

                <!-- æƒæçµæœèˆ‡æ“ä½œé¢æ¿ -->
                <div class="bg-white p-3 rounded-xl shadow-xl space-y-2 flex-shrink-0 mt-2">
                    <p class="text-center font-mono text-xs text-gray-500 truncate"><span class='font-bold text-gray-700'>ID:</span> <span id="res-id">---</span></p>
                    
                    <input 
                        type="text" 
                        id="res-name" 
                        onchange="handleNameUpdate()"
                        placeholder="è«‹å…ˆæƒæå•†å“"
                        class="w-full p-1.5 border-2 border-gray-300 rounded-lg text-center font-bold text-sm focus:border-indigo-500 transition"
                    />

                    <div class="flex justify-between items-center bg-indigo-50 p-2 rounded-xl">
                        <span class="text-sm text-indigo-700 font-semibold">ç›®å‰åº«å­˜:</span>
                        <span id="res-qty" class="text-2xl font-extrabold text-indigo-600 transition-transform duration-300">0</span>
                    </div>

                    <div class="bg-gray-100 p-2 rounded-xl space-y-1">
                        <label class="text-xs font-semibold text-gray-700 block">ç•°å‹•æ•¸é‡:</label>
                        
                        <div class="flex gap-2">
                            <input 
                                type="number" 
                                id="op-amount" 
                                value="1" 
                                min="1" 
                                inputmode="numeric"
                                class="flex-grow p-1.5 border-2 border-gray-300 rounded-lg text-center font-semibold text-base"
                            />
                            <button 
                                onclick="fillMaxStock()"
                                class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-2 rounded-lg shadow transition duration-150 text-xs flex-shrink-0"
                            >
                                å¡«å…¥åº«å­˜
                            </button>
                        </div>

                        <div class="grid grid-cols-2 gap-2 pt-1">
                            <button 
                                onclick="handleStock(1)"
                                class="stock-operation-button bg-green-500 hover:bg-green-600 text-white font-extrabold py-2.5 rounded-xl shadow-md transition transform hover:scale-[1.01] text-sm"
                            >
                                <span class="text-xl">+</span> å…¥åº«
                            </button>
                            <button 
                                onclick="handleStock(-1)"
                                class="stock-operation-button bg-red-500 hover:bg-red-600 text-white font-extrabold py-2.5 rounded-xl shadow-md transition transform hover:scale-[1.01] text-sm"
                            >
                                <span class="text-xl">-</span> å‡ºåº«
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- 2. åº«å­˜åˆ—è¡¨é é¢ (åŒ…å«æ‰‹å‹•å…¥åº«æŒ‰éˆ•) -->
        <div id="view-list" class="hidden h-full flex flex-col">
            <div class="sticky top-0 z-10 bg-gray-50 p-4 pb-2 shadow-inner border-b">
                <input
                    type="text"
                    id="search-input"
                    placeholder="ğŸ” æœå°‹å•†å“ç·¨è™Ÿæˆ–åç¨±..."
                    onkeyup="filterList()"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 transition mb-3"
                />
                <div class="grid grid-cols-2 gap-2">
                    <button 
                        onclick="showManualInboundModal()"
                        class="manager-only-button bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg shadow transition"
                    >
                        â• æ‰‹å‹•å…¥åº«
                    </button>
                     <button 
                        onclick="exportToExcel()"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-lg shadow transition"
                    >
                        ğŸ“¥ åŒ¯å‡º Excel (CSV)
                    </button>
                </div>
            </div>
            
            <div id="list-container" class="flex-grow p-4 space-y-2">
                <p class="text-center text-gray-500 py-10">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <!-- 3. ç´€éŒ„é é¢ (ä¿æŒä¸è®Š) -->
        <div id="view-logs" class="hidden p-4 overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ğŸ“ è¿‘æœŸç•°å‹• (æœ€å¤š 50 ç­†)</h3>
            <div id="logs-container" class="space-y-3">
                <p class="text-center text-gray-500 py-10">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <!-- 4. è£½ç¢¼é é¢ (åŠ å…¥æ¬Šé™æç¤º) -->
        <div id="view-create" class="hidden p-4">
            <div class="bg-white p-6 rounded-xl shadow-xl text-center space-y-6">
                <h3 class="text-2xl font-bold text-indigo-600">ğŸ–¨ï¸ æ¨™ç±¤è£½ä½œèˆ‡åˆ—å°</h3>
                
                <p class="text-sm text-red-500 font-semibold" id="create-permission-warning" style="display: none;">
                    â— åªæœ‰ç®¡ç†å“¡æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚
                </p>

                <input
                    type="text"
                    id="new-code"
                    placeholder="è«‹è¼¸å…¥å•†å“ç·¨è™Ÿ (SKU)"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg text-center font-mono text-lg focus:border-indigo-500 transition"
                />

                <button 
                    onclick="makeQR()"
                    class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-md transition"
                >
                    ç”Ÿæˆ QR Code
                </button>

                <div class="flex justify-center mt-6 print-area">
                    <div class="p-4 bg-white border-2 border-dashed border-gray-300 rounded-xl shadow-inner">
                        <div id="qrcode-display-canvas" class="flex items-center justify-center w-[150px] h-[150px]">
                            <p class="text-sm text-gray-400">é»æ“Šç”Ÿæˆï¼Œå³å¯åœ¨æ­¤è™•é¡¯ç¤º</p>
                        </div>
                    </div>
                </div>

                <button 
                    onclick="window.print()"
                    class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 rounded-xl shadow-md transition mt-4 print:hidden"
                >
                    åˆ—å°æ­¤æ¨™ç±¤
                </button>
            </div>
        </div>
    </main>

    <!-- Footer Navigation -->
    <nav class="flex-shrink-0 flex justify-around items-center bg-white border-t border-gray-200 shadow-xl p-2">
        <button class="nav-btn flex flex-col items-center justify-center p-2 transition duration-200 text-indigo-600" onclick="switchView('scan')" data-view="scan">
            <span class="text-2xl">ğŸ“·</span>
            <span class="text-xs font-medium mt-1">æƒæå…¥åº«</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center p-2 transition duration-200 text-gray-500 hover:text-indigo-400" onclick="switchView('list')" data-view="list">
            <span class="text-2xl">ğŸ“¦</span>
            <span class="text-xs font-medium mt-1">åº«å­˜åˆ—è¡¨</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center p-2 transition duration-200 text-gray-500 hover:text-indigo-400" onclick="switchView('logs')" data-view="logs">
            <span class="text-2xl">ğŸ“</span>
            <span class="text-xs font-medium mt-1">æ­·å²ç´€éŒ„</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center p-2 transition duration-200 text-gray-500 hover:text-indigo-400" onclick="switchView('create')" data-view="create">
            <span class="text-2xl">ğŸ·ï¸</span>
            <span class="text-xs font-medium mt-1">æ¨™ç±¤è£½ç¢¼</span>
        </button>
    </nav>
</div>

<!-- æ¨¡æ…‹æ¡† (å•†å“è©³æƒ…èˆ‡ç·¨è¼¯) -->
<div id="detail-modal" class="fixed inset-0 z-50 bg-black bg-opacity-70 transition-opacity duration-300 opacity-0 pointer-events-none flex justify-center items-end" onclick="if(event.target.id === 'detail-modal') closeDetailModal()">
    <div id="modal-content" class="bg-gray-100 w-full max-w-md h-[90vh] rounded-t-2xl shadow-2xl flex flex-col transition-transform duration-300 translate-y-full">
        <div class="flex-shrink-0 p-4 bg-white rounded-t-2xl shadow-lg flex justify-between items-center border-b">
            <h2 id="modal-title" class="text-xl font-bold text-gray-800 truncate">å•†å“è©³æƒ…</h2>
            <button onclick="closeDetailModal()" class="text-3xl font-light text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        
        <div class="overflow-y-auto p-4 space-y-4 flex-grow">
            
            <div id="admin-warning" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded" style="display: none;">
                <p class="font-bold">æ¬Šé™å—é™</p>
                <p class="text-sm">æ‚¨ç•¶å‰çš„è§’è‰²åªèƒ½æŸ¥çœ‹ã€‚è«‹ä»¥ç®¡ç†å“¡èº«ä»½ç™»å…¥æ‰èƒ½ç·¨è¼¯è³‡è¨Šå’Œæ‰‹å‹•èª¿æ•´åº«å­˜ã€‚</p>
            </div>

            <!-- åŸºæœ¬è³‡è¨Šå¡ç‰‡ -->
            <div class="bg-white p-5 rounded-xl shadow-md space-y-3">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">åŸºæœ¬è³‡è¨Šèˆ‡ç·¨è¼¯</h3>
                
                <p class="text-sm text-gray-500 font-mono truncate">æ–™è™Ÿ (ID): <span id="detail-id" class="text-gray-800 font-bold">---</span></p>

                <div>
                    <label class="text-sm font-medium text-gray-600 block mb-1">å“å</label>
                    <input type="text" id="detail-name" onchange="updateDetailInfo()"
                        placeholder="è¼¸å…¥å•†å“åç¨±"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:border-indigo-500"
                    />
                </div>

                <div>
                    <label class="text-sm font-medium text-gray-600 block mb-1">å­˜æ”¾ä½ç½®</label>
                    <input type="text" id="detail-location" onchange="updateDetailInfo()"
                        placeholder="ä¾‹å¦‚: Aæ¶-3å±¤"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:border-indigo-500"
                    />
                </div>
                
                <p class="text-sm text-gray-500">æœ€å¾Œå…¥åº«æ—¥: <span id="detail-inbound-date" class="text-gray-800">---</span></p>
            </div>
            
            <!-- åº«å­˜èª¿æ•´å¡ç‰‡ -->
            <div class="bg-white p-5 rounded-xl shadow-md space-y-3">
                <h3 class="text-lg font-semibold text-gray-700">æ‰‹å‹•èª¿æ•´åº«å­˜ (è¦†è“‹ç¸½æ•¸)</h3>
                <div class="flex items-center justify-between bg-indigo-50 p-3 rounded-lg">
                    <span class="text-indigo-700 font-medium">èª¿æ•´ç‚ºæ­¤æ•¸é‡:</span>
                    <input type="number" id="detail-qty-input" value="0" min="0" inputmode="numeric"
                        class="w-24 p-2 border-2 border-indigo-300 rounded-lg text-center font-bold text-xl"
                    />
                </div>
                
                <button id="handle-manual-update-btn" onclick="handleManualUpdate()" class="manager-only-button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition mt-2">
                    å„²å­˜ä¸¦è¦†è“‹åº«å­˜ç¸½æ•¸
                </button>
            </div>

            <!-- æ­·å²ç´€éŒ„å¡ç‰‡ -->
            <div class="bg-white p-5 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">ğŸšš é€²å‡ºè²¨æ­·å²ç´€éŒ„</h3>
                <ul id="detail-history-list" class="space-y-2">
                    <li class="text-center text-gray-500">è¼‰å…¥ä¸­...</li>
                </ul>
            </div>

        </div>
    </div>
</div>

<!-- ç™»å…¥æ¨¡æ…‹æ¡† (ç”¨æ–¼ç®¡ç†å“¡ç™»å…¥) -->
<div id="login-modal" class="fixed inset-0 z-[100] bg-black bg-opacity-80 transition-opacity duration-300 opacity-0 pointer-events-none flex justify-center items-center" onclick="if(event.target.id === 'login-modal') closeLoginModal()">
    <div id="login-modal-content" class="bg-white w-full max-w-sm rounded-xl shadow-2xl flex flex-col transition-transform duration-300 translate-y-full p-6 space-y-4">
        <h2 class="text-2xl font-bold text-indigo-700 text-center">ğŸ” è«‹ç™»å…¥</h2>
        <p class="text-sm text-gray-600 text-center">è«‹è¼¸å…¥æ‚¨çš„é›»å­éƒµä»¶å’Œå¯†ç¢¼ä»¥é€²å…¥ç³»çµ±ã€‚</p>
        
        <div>
            <label class="text-sm font-medium text-gray-600 block mb-1">é›»å­éƒµä»¶</label>
            <input type="email" id="login-email" placeholder="email@example.com" inputmode="email" // FIX: æ·»åŠ  inputmode="email"
                class="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500"
            />
        </div>
        
        <div>
            <label class="text-sm font-medium text-gray-600 block mb-1">å¯†ç¢¼</label>
            <input type="password" id="login-password" placeholder="å¯†ç¢¼"
                class="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500"
            />
        </div>

        <button onclick="handleEmailPasswordLogin()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition">
            ç™»å…¥
        </button>

        <button onclick="closeLoginModal()" class="w-full text-sm text-gray-500 hover:text-indigo-500 transition py-1">
            å–æ¶ˆ (æ­¤æŒ‰éˆ•å·²éš±è—)
        </button>
         <p class="text-xs text-red-500 text-center">
         </p>
    </div>
</div>

<!-- æ¨¡æ…‹æ¡† (æ‰‹å‹•å…¥åº«) -->
<div id="manual-inbound-modal" class="fixed inset-0 z-[60] bg-black bg-opacity-70 transition-opacity duration-300 opacity-0 pointer-events-none flex justify-center items-center" onclick="if(event.target.id === 'manual-inbound-modal') closeManualInboundModal()">
    <div id="manual-inbound-modal-content" class="bg-white w-full max-w-sm rounded-xl shadow-2xl flex flex-col transition-transform duration-300 translate-y-full p-6 space-y-4">
        <h2 class="text-2xl font-bold text-green-700 text-center border-b pb-2">â• æ‰‹å‹•å…¥åº« (éæƒæ)</h2>
        <p class="text-sm text-gray-600 text-center">é©ç”¨æ–¼æ²’æœ‰ QR Code æˆ–ç·Šæ€¥å…¥åº«çš„æƒ…æ³ã€‚</p>
        
        <div>
            <label class="text-sm font-medium text-gray-600 block mb-1">å•†å“ ID (SKU)</label>
            <input type="text" id="detail-qty-input-id" placeholder="è«‹è¼¸å…¥å•†å“ ID (å¿…å¡«)"
                class="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-green-500 font-mono"
            />
        </div>
        
        <div>
            <label class="text-sm font-medium text-gray-600 block mb-1">å…¥åº«æ•¸é‡</label>
            <input type="number" id="manual-inbound-qty" value="1" min="1" inputmode="numeric"
                class="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-green-500 text-center font-bold text-xl"
            />
        </div>

        <button onclick="handleManualInbound()" id="manual-inbound-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg transition">
            åŸ·è¡Œæ‰‹å‹•å…¥åº«
        </button>
         
        <button onclick="closeManualInboundModal()" class="w-full text-sm text-gray-500 hover:text-red-500 transition py-1">
            å–æ¶ˆ
        </button>
    </div>
</div>


<!-- éŒ¯èª¤è¨Šæ¯æç¤º -->
<div id="error-banner" class="hidden" onclick="this.style.display='none'"></div>

</body>
</html>
