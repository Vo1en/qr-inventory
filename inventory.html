<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡æ˜“ QR Code åº«å­˜ç³»çµ±</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        h2 { text-align: center; color: #333; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* æƒæå€åŸŸæ¨£å¼ */
        #reader { width: 100%; border-radius: 8px; overflow: hidden; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; }
        .btn-in { background-color: #4CAF50; color: white; } /* å…¥åº«ç¶ è‰² */
        .btn-out { background-color: #f44336; color: white; } /* å‡ºåº«ç´…è‰² */
        .btn-gen { background-color: #2196F3; color: white; } /* ç”Ÿæˆè—è‰² */
        
        input { padding: 10px; width: 70%; border: 1px solid #ddd; border-radius: 5px; }
        
        /* éš±è—/é¡¯ç¤ºæ§åˆ¶ */
        .hidden { display: none; }
        
        #scan-result { margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 5px; text-align: center; }
        #stock-display { font-size: 24px; font-weight: bold; color: #333; }
        #qrcode-container { margin-top: 15px; display: flex; justify-content: center; }
    </style>
</head>
<body>

    <h2>ğŸ“¦ è²¨ç‰©æƒç¢¼ç®¡ç†ç³»çµ±</h2>

    <div class="card">
        <h3>1. æƒæè²¨ç‰©</h3>
        <div id="reader"></div>
        <div id="scan-result" class="hidden">
            <p>è­˜åˆ¥å•†å“ï¼š<b id="product-id">---</b></p>
            <p>ç›®å‰åº«å­˜ï¼š<span id="stock-display">0</span></p>
            <hr>
            <p>æ“ä½œï¼š</p>
            <button class="btn-in" onclick="updateStock(1)">+ å…¥åº« (é€²è²¨)</button>
            <button class="btn-out" onclick="updateStock(-1)">- å‡ºåº« (ç™¼è²¨)</button>
        </div>
    </div>

    <div class="card">
        <h3>2. è£½ä½œæ–°æ¨™ç±¤</h3>
        <input type="text" id="new-item-name" placeholder="è¼¸å…¥å•†å“åç¨± (å¦‚: A-001)">
        <button class="btn-gen" onclick="generateQR()">ç”Ÿæˆ QR Code</button>
        <div id="qrcode-container"></div>
    </div>

    <div class="card">
        <h3>3. æ‰€æœ‰åº«å­˜æ¸…å–® (æ¨¡æ“¬è³‡æ–™åº«)</h3>
        <ul id="inventory-list"></ul>
    </div>

    <script>
        // --- æ¨¡æ“¬è³‡æ–™åº« (ä½¿ç”¨ LocalStorage) ---
        // å¯¦éš›é–‹ç™¼æ™‚ï¼Œé€™è£¡æœƒæ›¿æ›æˆä½ çš„ Firebase ç¨‹å¼ç¢¼
        const defaultData = {
            'PROD-001': { name: 'PROD-001', qty: 50 },
            'PROD-002': { name: 'PROD-002', qty: 120 }
        };

        // è®€å–è³‡æ–™åº«
        function getDB() {
            const data = localStorage.getItem('myInventory');
            return data ? JSON.parse(data) : defaultData;
        }

        // å„²å­˜è³‡æ–™åº«
        function saveDB(data) {
            localStorage.setItem('myInventory', JSON.stringify(data));
            renderList();
        }

        let currentScannedId = null;

        // --- æ ¸å¿ƒåŠŸèƒ½ 1: æƒæè¨­å®š ---
        const html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", { fps: 10, qrbox: 250 });

        function onScanSuccess(decodedText, decodedResult) {
            // æƒææˆåŠŸå¾Œçš„å‹•ä½œ
            currentScannedId = decodedText;
            
            // é¡¯ç¤ºæ“ä½œä»‹é¢
            document.getElementById('scan-result').classList.remove('hidden');
            document.getElementById('product-id').innerText = decodedText;
            
            // è®€å–è©²å•†å“çš„åº«å­˜
            const db = getDB();
            if (!db[decodedText]) {
                // å¦‚æœæ˜¯æ–°å•†å“ï¼Œåˆå§‹åŒ–ç‚º 0
                db[decodedText] = { name: decodedText, qty: 0 };
                saveDB(db);
            }
            document.getElementById('stock-display').innerText = db[decodedText].qty;
            
            // æš«åœæƒæ (é¿å…ä¸€ç›´é‡è¤‡è§¸ç™¼)
            // html5QrcodeScanner.pause(); 
            // é€™è£¡ç‚ºäº†æ¼”ç¤ºæ–¹ä¾¿ä¸æš«åœï¼Œå¯¦éš›ä½¿ç”¨å»ºè­°æš«åœæˆ–é¡¯ç¤ºæƒææˆåŠŸæç¤º
        }

        html5QrcodeScanner.render(onScanSuccess);

        // --- æ ¸å¿ƒåŠŸèƒ½ 2: æ›´æ–°åº«å­˜ (å…¥åº«/å‡ºåº«) ---
        function updateStock(change) {
            if (!currentScannedId) return;

            const db = getDB();
            if (db[currentScannedId]) {
                db[currentScannedId].qty += change;
                // æ›´æ–°ç•«é¢
                document.getElementById('stock-display').innerText = db[currentScannedId].qty;
                saveDB(db); // å­˜å…¥ LocalStorage
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ 3: ç”Ÿæˆ QR Code ---
        function generateQR() {
            const text = document.getElementById('new-item-name').value;
            if (!text) return alert("è«‹è¼¸å…¥å•†å“åç¨±");

            const container = document.getElementById('qrcode-container');
            container.innerHTML = ""; // æ¸…ç©ºèˆŠçš„
            
            new QRCode(container, {
                text: text,
                width: 128,
                height: 128
            });
        }

        // --- è¼”åŠ©: æ¸²æŸ“åˆ—è¡¨ ---
        function renderList() {
            const list = document.getElementById('inventory-list');
            const db = getDB();
            list.innerHTML = "";
            for (let key in db) {
                const item = db[key];
                const li = document.createElement('li');
                li.textContent = `${item.name} : åº«å­˜ ${item.qty}`;
                list.appendChild(li);
            }
        }

        // åˆå§‹åŒ–
        renderList();
    </script>
</body>
</html>