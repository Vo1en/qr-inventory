<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§åº«å­˜ç®¡ç†ç³»çµ± Ultra</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --nav-height: 60px;
            --header-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); margin: 0; padding: 0; 
            height: 100vh; overflow: hidden; /* ç¦æ­¢æ•´å€‹ç¶²é æ²å‹• */
            display: flex; flex-direction: column;
        }

        /* é ‚éƒ¨æ¨™é¡Œåˆ— (å›ºå®š) */
        header { 
            height: var(--header-height);
            background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 700; }
        .status-dot { width: 10px; height: 10px; background: #ccc; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .status-dot.online { background: #4ade80; }

        /* ä¸­é–“å…§å®¹å€ (å¯æ²å‹•) */
        main { 
            flex: 1; 
            overflow-y: auto; /* åªæœ‰é€™è£¡å¯ä»¥æ²å‹• */
            padding: 15px; 
            padding-bottom: 20px;
            position: relative;
        }

        /* åº•éƒ¨å°èˆªåˆ— (å›ºå®š) */
        nav {
            height: var(--nav-height);
            background: white; border-top: 1px solid #e5e7eb;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 10;
        }
        .nav-btn {
            background: none; border: none; 
            color: #94a3b8; font-size: 0.8rem; font-weight: 600;
            display: flex; flex-direction: column; align-items: center;
            padding: 5px; width: 100%;
        }
        .nav-btn.active { color: var(--primary); }
        .nav-icon { font-size: 1.2rem; margin-bottom: 2px; }

        /* å¡ç‰‡æ¨£å¼ */
        .card { 
            background: var(--card); border-radius: 12px; 
            padding: 15px; margin-bottom: 15px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
        }

        /* ğŸ“· ç›¸æ©Ÿå€åŸŸå„ªåŒ– */
        #camera-wrapper {
            position: relative; border-radius: 12px; overflow: hidden; background: black;
            height: 300px; display: flex; align-items: center; justify-content: center;
        }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        /* éš±è— html5-qrcode é è¨­çš„é†œé†œé‚Šæ¡†å’ŒæŒ‰éˆ• */
        #reader video { object-fit: cover; border-radius: 12px; }

        /* çµæœé¢æ¿ */
        .result-panel { display: none; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        input[type="text"] {
            width: 100%; padding: 12px; text-align: center;
            border: 2px solid #e2e8f0; border-radius: 8px;
            font-size: 1rem; margin: 10px 0; outline: none;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus { border-color: var(--primary); }

        .qty-display { 
            font-size: 3.5rem; font-weight: 800; color: var(--primary); 
            text-align: center; margin: 5px 0; 
        }

        /* æŒ‰éˆ•å„ªåŒ– */
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn {
            padding: 16px; border: none; border-radius: 10px;
            font-size: 1.1rem; font-weight: bold; color: white;
            cursor: pointer; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        .btn:active { transform: scale(0.96); filter: brightness(90%); }
        .btn-in { background: var(--success); }
        .btn-out { background: var(--danger); }
        .btn-gen { background: var(--primary); width: 100%; margin-top: 10px; }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-item { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #f1f5f9;
        }
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .tag-in { background: #dcfce7; color: #166534; }
        .tag-out { background: #fee2e2; color: #991b1b; }

        /* æœå°‹æ¡† */
        .search-bar {
            position: sticky; top: 0; background: var(--bg);
            padding: 0 0 10px 0; z-index: 5;
        }
    </style>
</head>
<body>

    <header>
        <h1>ğŸ“¦ åº«å­˜ç³»çµ± Ultra</h1>
        <div id="status-light" class="status-dot"></div>
    </header>

    <main id="main-content">
        <div id="view-scan">
            <div class="card" style="padding:0;">
                <div id="camera-wrapper">
                    <div id="reader"></div>
                    <div style="position:absolute; color:white; font-size:0.9rem; z-index:2; pointer-events:none;">
                        ğŸ“· å°æº– QR Code
                    </div>
                </div>
            </div>

            <div id="scan-result" class="card result-panel">
                <div style="text-align:center; color:#64748b; font-family:monospace;" id="res-id">---</div>
                <input type="text" id="res-name" placeholder="è¼¸å…¥åç¨± (å¦‚: èºçµ²)" onchange="updateInfo()">
                <div class="qty-display" id="res-qty">0</div>
                <div style="text-align:center; color:#94a3b8; font-size:0.8rem; margin-bottom:15px;">ç›®å‰åº«å­˜</div>
                
                <div class="btn-row">
                    <button class="btn btn-in" onclick="handleStock(1)">
                        <span>ï¼‹ å…¥åº«</span>
                    </button>
                    <button class="btn btn-out" onclick="handleStock(-1)">
                        <span>ï¼ å‡ºåº«</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="view-list" style="display:none;">
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="ğŸ” æœå°‹å•†å“..." onkeyup="filterList()">
            </div>
            <div class="card" id="list-container">
                <div style="text-align:center; padding:20px; color:#94a3b8;">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div id="view-logs" style="display:none;">
            <div class="card">
                <h3 style="margin-top:0;">ğŸ“ è¿‘æœŸç•°å‹•</h3>
                <div id="logs-container"></div>
            </div>
        </div>

        <div id="view-create" style="display:none;">
            <div class="card" style="text-align:center;">
                <h3>ğŸ–¨ï¸ æ¨™ç±¤è£½ä½œ</h3>
                <input type="text" id="new-code" placeholder="è¼¸å…¥ç·¨è™Ÿ (å¦‚: A-001)">
                <button class="btn btn-gen" onclick="makeQR()">ç”Ÿæˆ</button>
                <div id="qrcode" style="margin-top:20px; display:flex; justify-content:center;"></div>
            </div>
        </div>
    </main>

    <nav>
        <button class="nav-btn active" onclick="switchView('scan')">
            <span class="nav-icon">ğŸ“·</span> æƒæ
        </button>
        <button class="nav-btn" onclick="switchView('list')">
            <span class="nav-icon">ğŸ“¦</span> åº«å­˜
        </button>
        <button class="nav-btn" onclick="switchView('logs')">
            <span class="nav-icon">ğŸ“</span> ç´€éŒ„
        </button>
        <button class="nav-btn" onclick="switchView('create')">
            <span class="nav-icon">ğŸ·ï¸</span> è£½ç¢¼
        </button>
    </nav>

    <script>
        // --- è¨­å®š (è«‹ç¢ºèª Config) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAUgk7DGfnCCt1-cTAhvD2Se4YZQEoXUE8",
            authDomain: "qr-inventory-2e995.firebaseapp.com",
            projectId: "qr-inventory-2e995",
            storageBucket: "qr-inventory-2e995.firebasestorage.app",
            messagingSenderId: "1041449207118",
            appId: "1:1041449207118:web:d8c66fa15024471f0d0a1f",
            measurementId: "G-YGQYMSS6E3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        document.getElementById('status-light').classList.add('online');

        // --- å…¨åŸŸè®Šæ•¸ ---
        let html5QrCode;
        let currentId = null;
        let isProcessing = false;
        let allData = [];

        // --- 1. ç›¸æ©Ÿæ§åˆ¶ (æ ¸å¿ƒå„ªåŒ–) ---
        // ä½¿ç”¨ Html5Qrcode (é Scanner) ä¾†å®Œå…¨æ§åˆ¶ UIï¼Œå¼·åˆ¶å¾Œé¡é ­
        function startCamera() {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            // å¼·åˆ¶ä½¿ç”¨ environment (å¾Œç½®) é¡é ­
            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                if (currentId === decodedText) return;
                
                vibrate([50]); // æƒåˆ°æ™‚çŸ­éœ‡å‹•
                currentId = decodedText;
                fetchData(decodedText);
            }).catch(err => {
                console.log("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•— (å¯èƒ½æ˜¯åˆ‡æ›é é¢å°è‡´):", err);
            });
        }

        function stopCamera() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => console.log("ç›¸æ©Ÿå·²æš«åœ")).catch(err => console.log(err));
            }
        }

        // --- 2. è³‡æ–™åº«é‚è¼¯ ---
        function fetchData(id) {
            document.getElementById('scan-result').style.display = 'block';
            document.getElementById('res-id').innerText = id;
            
            db.collection("inventory").doc(id).onSnapshot(doc => {
                if (doc.exists) {
                    const d = doc.data();
                    document.getElementById('res-qty').innerText = d.qty;
                    document.getElementById('res-name').value = d.name || "";
                } else {
                    document.getElementById('res-qty').innerText = 0;
                    document.getElementById('res-name').value = "";
                    document.getElementById('res-name').placeholder = "æ–°å•†å“ - è«‹å‘½å";
                }
            });
        }

        function handleStock(change) {
            if (!currentId || isProcessing) return;
            vibrate([30]); // æŒ‰ä¸‹æŒ‰éˆ•ç¬é–“éœ‡å‹•
            
            isProcessing = true;
            const docRef = db.collection("inventory").doc(currentId);
            const batch = db.batch();
            const name = document.getElementById('res-name').value || "æœªå‘½å";

            // åº«å­˜æ›´æ–°
            docRef.get().then(doc => {
                if (!doc.exists) {
                    batch.set(docRef, { qty: change > 0 ? change : 0, name: name, id: currentId, updatedAt: new Date() });
                } else {
                    batch.update(docRef, { qty: firebase.firestore.FieldValue.increment(change), name: name, updatedAt: new Date() });
                }

                // ç´€éŒ„
                const logRef = db.collection("logs").doc();
                batch.set(logRef, {
                    productId: currentId, productName: name,
                    action: change > 0 ? "å…¥åº«" : "å‡ºåº«",
                    amount: Math.abs(change), timestamp: new Date()
                });

                return batch.commit();
            }).then(() => {
                vibrate([50, 50]); // æˆåŠŸå¾Œé›™éœ‡å‹•
            }).catch(err => alert(err)).finally(() => isProcessing = false);
        }

        function updateInfo() {
            if(currentId) db.collection("inventory").doc(currentId).set({ name: document.getElementById('res-name').value, id: currentId }, { merge: true });
        }

        // --- 3. åº«å­˜è¡¨èˆ‡ç´€éŒ„ç›£è½ ---
        db.collection("inventory").onSnapshot(snap => {
            allData = [];
            snap.forEach(doc => allData.push({ ...doc.data(), id: doc.id }));
            renderList(allData);
        });

        function renderList(data) {
            const container = document.getElementById('list-container');
            if(data.length === 0) return container.innerHTML = "<div style='text-align:center;color:#ccc'>ç„¡è³‡æ–™</div>";
            
            container.innerHTML = data.map(item => `
                <div class="list-item">
                    <div>
                        <div style="font-weight:600">${item.name || "æœªå‘½å"}</div>
                        <div style="font-size:0.8rem; color:#94a3b8; font-family:monospace;">${item.id}</div>
                    </div>
                    <div style="font-size:1.2rem; font-weight:800; color:${item.qty < 5 ? 'var(--danger)' : 'var(--primary)'}">${item.qty}</div>
                </div>
            `).join('');
        }

        function filterList() {
            const key = document.getElementById('search-input').value.toLowerCase();
            renderList(allData.filter(i => (i.id+i.name).toLowerCase().includes(key)));
        }

        db.collection("logs").orderBy("timestamp", "desc").limit(20).onSnapshot(snap => {
            const container = document.getElementById('logs-container');
            container.innerHTML = snap.docs.map(doc => {
                const d = doc.data();
                const time = d.timestamp ? new Date(d.timestamp.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "--:--";
                const isIn = d.action === "å…¥åº«";
                return `
                <div class="list-item">
                    <div>
                        <div style="font-weight:600">${d.productName}</div>
                        <div style="font-size:0.75rem; color:#94a3b8;">${time}</div>
                    </div>
                    <div style="text-align:right;">
                        <span class="tag ${isIn ? 'tag-in':'tag-out'}">${d.action} ${d.amount}</span>
                    </div>
                </div>`;
            }).join('');
        });

        // --- 4. è¼”åŠ©åŠŸèƒ½ ---
        function switchView(view) {
            // åˆ‡æ›é é¢é¡¯ç¤º
            ['scan', 'list', 'logs', 'create'].forEach(v => {
                document.getElementById('view-' + v).style.display = (v === view) ? 'block' : 'none';
            });
            
            // æŒ‰éˆ•ç‹€æ…‹åˆ‡æ›
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // æ™ºèƒ½ç›¸æ©Ÿç®¡ç† (é›¢é–‹æƒæé å°±é—œé¡é ­ï¼Œçœé›» + é¿å… bug)
            if (view === 'scan') {
                setTimeout(startCamera, 100); // å»¶é²ä¸€é»é»ç¢ºä¿ DOM æº–å‚™å¥½
            } else {
                stopCamera();
            }
        }

        function makeQR() {
            const text = document.getElementById('new-code').value;
            if(!text) return;
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById('qrcode'), { text: text, width: 128, height: 128 });
        }

        function vibrate(pattern) {
            if (navigator.vibrate) navigator.vibrate(pattern);
        }

        // åˆå§‹åŒ–ï¼šé è¨­é–‹å•Ÿç›¸æ©Ÿ
        startCamera();
    </script>
</body>
</html>
