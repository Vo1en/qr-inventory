<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯å³æ™‚åº«å­˜ç³»çµ±</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        h2 { text-align: center; color: #333; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #reader { width: 100%; border-radius: 8px; overflow: hidden; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; }
        .btn-in { background-color: #4CAF50; color: white; }
        .btn-out { background-color: #f44336; color: white; }
        .btn-gen { background-color: #2196F3; color: white; }
        input { padding: 10px; width: 70%; border: 1px solid #ddd; border-radius: 5px; }
        .hidden { display: none; }
        #scan-result { margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 5px; text-align: center; }
        #stock-display { font-size: 24px; font-weight: bold; color: #333; }
        #qrcode-container { margin-top: 15px; display: flex; justify-content: center; }
        ul { padding-left: 20px; }
        li { margin-bottom: 5px; color: #555; }
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px;}
        .status-online { background-color: #4CAF50; }
    </style>
</head>
<body>

    <h2>ğŸ“¦ é›²ç«¯åº«å­˜ç³»çµ± <span id="status" class="status-dot"></span></h2>

    <div class="card">
        <h3>1. æƒæè²¨ç‰©</h3>
        <div id="reader"></div>
        <div id="scan-result" class="hidden">
            <p>å•†å“ IDï¼š<b id="product-id">---</b></p>
            <p>é›²ç«¯åº«å­˜ï¼š<span id="stock-display">è®€å–ä¸­...</span></p>
            <hr>
            <button class="btn-in" onclick="updateCloudStock(1)">+ å…¥åº«</button>
            <button class="btn-out" onclick="updateCloudStock(-1)">- å‡ºåº«</button>
        </div>
    </div>

    <div class="card">
        <h3>2. è£½ä½œæ–°æ¨™ç±¤</h3>
        <input type="text" id="new-item-name" placeholder="è¼¸å…¥å•†å“ ID (å¦‚: PROD-888)">
        <button class="btn-gen" onclick="generateQR()">ç”Ÿæˆ QR Code</button>
        <div id="qrcode-container"></div>
    </div>

    <div class="card">
        <h3>3. å³æ™‚åº«å­˜æ¸…å–®</h3>
        <p style="font-size:12px; color:#888;">* é€™è£¡çš„æ•¸æ“šæœƒè‡ªå‹•åŒæ­¥</p>
        <ul id="inventory-list"><li>æ­£åœ¨é€£ç·šè‡³ Firebase...</li></ul>
    </div>

    <script>
        // --- 1. Firebase è¨­å®š (å·²å¡«å…¥ä½ çš„è³‡æ–™) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAUgk7DGfnCCt1-cTAhvD2Se4YZQEoXUE8",
            authDomain: "qr-inventory-2e995.firebaseapp.com",
            projectId: "qr-inventory-2e995",
            storageBucket: "qr-inventory-2e995.firebasestorage.app",
            messagingSenderId: "1041449207118",
            appId: "1:1041449207118:web:d8c66fa15024471f0d0a1f",
            measurementId: "G-YGQYMSS6E3"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // æª¢æŸ¥é€£ç·šç‹€æ…‹
        document.getElementById('status').classList.add('status-online');
        console.log("Firebase é€£ç·šæˆåŠŸï¼");

        // --- 2. ç›£è½è³‡æ–™åº«è®ŠåŒ– (Real-time Listener) ---
        // åªè¦é›²ç«¯è³‡æ–™ä¸€è®Šï¼Œé€™è£¡é¦¬ä¸Šè‡ªå‹•åŸ·è¡Œï¼Œæ›´æ–°åˆ—è¡¨
        db.collection("inventory").onSnapshot((querySnapshot) => {
            const list = document.getElementById('inventory-list');
            list.innerHTML = ""; // æ¸…ç©ºèˆŠåˆ—è¡¨

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const li = document.createElement('li');
                li.innerHTML = `<b>${doc.id}</b> : ${data.qty} å€‹`;
                list.appendChild(li);
                
                // å¦‚æœç›®å‰æ­£åœ¨çœ‹é€™å€‹å•†å“ï¼Œé †ä¾¿æ›´æ–°ä¸Šæ–¹çš„é¡¯ç¤ºæ•¸å­—
                if (currentScannedId === doc.id) {
                    document.getElementById('stock-display').innerText = data.qty;
                }
            });

            if(querySnapshot.empty){
                list.innerHTML = "<li>ç›®å‰ç„¡è³‡æ–™ï¼Œè«‹å…ˆæƒææˆ–æ–°å¢ã€‚</li>";
            }
        });

        // --- 3. æƒç¢¼é‚è¼¯ ---
        let currentScannedId = null;
        const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });

        function onScanSuccess(decodedText) {
            currentScannedId = decodedText;
            document.getElementById('scan-result').classList.remove('hidden');
            document.getElementById('product-id').innerText = decodedText;

            // æŸ¥è©¢é€™å€‹å•†å“æ˜¯å¦å­˜åœ¨
            const docRef = db.collection("inventory").doc(decodedText);
            docRef.get().then((doc) => {
                if (doc.exists) {
                    document.getElementById('stock-display').innerText = doc.data().qty;
                } else {
                    document.getElementById('stock-display').innerText = "æ–°å•†å“ (0)";
                    // è‡ªå‹•å»ºç«‹é€™å€‹æ–°å•†å“æª”æ¡ˆï¼Œé è¨­ 0
                    docRef.set({ qty: 0 }); 
                }
            }).catch((error) => {
                console.error("è®€å–éŒ¯èª¤:", error);
                alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªä½ çš„ Firebase æœ‰é–‹å•Ÿ Test Mode");
            });
        }
        
        html5QrcodeScanner.render(onScanSuccess);

        // --- 4. æ›´æ–°åº«å­˜ (å¯«å…¥è³‡æ–™åº«) ---
        function updateCloudStock(change) {
            if (!currentScannedId) return;

            const docRef = db.collection("inventory").doc(currentScannedId);
            
            // ä½¿ç”¨ increment ç¢ºä¿å¤šäººåŒæ™‚æ“ä½œä¹Ÿä¸æœƒç®—éŒ¯
            docRef.update({
                qty: firebase.firestore.FieldValue.increment(change)
            }).catch((error) => {
                console.error("æ›´æ–°å¤±æ•—:", error);
                alert("æ›´æ–°å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™ã€‚");
            });
        }

        // --- 5. ç”Ÿæˆ QR Code ---
        function generateQR() {
            const text = document.getElementById('new-item-name').value;
            if (!text) return alert("è«‹è¼¸å…¥å•†å“ ID");
            document.getElementById('qrcode-container').innerHTML = "";
            new QRCode(document.getElementById('qrcode-container'), {
                text: text,
                width: 128,
                height: 128
            });
        }
    </script>
</body>
</html>
