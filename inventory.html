<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ™ºæ…§åº«å­˜ç³»çµ± Ultra</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --card: #ffffff;
            --nav-height: 70px;
            --header-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #e2e8f0; /* é›»è…¦ç‰ˆèƒŒæ™¯è‰² */
            margin: 0; padding: 0; 
            height: 100vh; 
            height: 100dvh; /* é‡å°æ‰‹æ©Ÿç€è¦½å™¨å‹•æ…‹é«˜åº¦å„ªåŒ– */
            overflow: hidden;
            display: flex; justify-content: center;
        }

        /* App å®¹å™¨ï¼šåœ¨é›»è…¦ä¸Šé™åˆ¶å¯¬åº¦ï¼Œæ‰‹æ©Ÿä¸Šæ»¿ç‰ˆ */
        .app-wrapper {
            width: 100%; max-width: 500px;
            background-color: var(--bg);
            height: 100%;
            display: flex; flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* é ‚éƒ¨æ¨™é¡Œåˆ— (å›ºå®š) */
        header { 
            flex: 0 0 var(--header-height);
            background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h1 { margin: 0; font-size: 1.1rem; font-weight: 700; letter-spacing: 1px; }
        .status-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.3); transition: background 0.3s; }
        .status-dot.online { background: #4ade80; box-shadow: 0 0 8px #4ade80; }

        /* ä¸­é–“å…§å®¹å€ (å¯æ²å‹•) */
        main { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            padding: 15px; 
            padding-bottom: calc(var(--nav-height) + 20px); /* é¿å…è¢«åº•éƒ¨å°èˆªé®ä½ */
            position: relative;
        }

        /* åº•éƒ¨å°èˆªåˆ— (å›ºå®š) */
        nav {
            flex: 0 0 var(--nav-height);
            background: white; border-top: 1px solid #e5e7eb;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 20;
            padding-bottom: env(safe-area-inset-bottom); /* é©é… iPhone åº•éƒ¨æ©«æ¢ */
        }
        .nav-btn {
            background: none; border: none; 
            color: #94a3b8; font-size: 0.75rem; font-weight: 600;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 5px; width: 100%; height: 100%;
            cursor: pointer;
        }
        .nav-btn.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 4px; }

        /* å¡ç‰‡æ¨£å¼ */
        .card { 
            background: var(--card); border-radius: 16px; 
            padding: 16px; margin-bottom: 16px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); 
        }

        /* ğŸ“· ç›¸æ©Ÿå€åŸŸ */
        #camera-wrapper {
            position: relative; border-radius: 12px; overflow: hidden; background: black;
            height: 280px; display: flex; align-items: center; justify-content: center;
        }
        #reader { width: 100%; height: 100%; }
        #reader video { object-fit: cover; width: 100% !important; height: 100% !important; border-radius: 12px; }

        /* çµæœé¢æ¿å‹•ç•« */
        .result-panel { display: none; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* è¼¸å…¥æ¡†é€šç”¨ */
        input[type="text"], input[type="number"] {
            width: 100%; padding: 12px; text-align: center;
            border: 2px solid #e2e8f0; border-radius: 10px;
            font-size: 1.1rem; margin: 8px 0;
            transition: border-color 0.2s;
            background: #f8fafc;
        }
        input:focus { border-color: var(--primary); background: #fff; }

        /* æ•¸é‡èˆ‡åº«å­˜é¡¯ç¤º */
        .info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .stock-label { font-size: 0.9rem; color: #64748b; }
        .current-stock { font-size: 1.5rem; font-weight: 800; color: var(--primary); }

        /* æ•¸é‡æ“ä½œå€ */
        .action-area { background: #f1f5f9; padding: 15px; border-radius: 12px; margin-top: 10px; }
        .qty-control { display: flex; gap: 10px; margin-bottom: 15px; }
        .qty-input { flex: 1; font-size: 1.5rem !important; font-weight: bold; color: #333; }
        
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn {
            padding: 15px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: bold; color: white;
            cursor: pointer; position: relative; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn:active { transform: scale(0.97); filter: brightness(95%); }
        .btn-in { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-out { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-gen { background: var(--primary); width: 100%; margin-top: 10px; }
        .btn span { font-size: 0.8rem; opacity: 0.8; font-weight: normal; margin-top: 2px; }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-item { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #f1f5f9;
        }
        .tag { padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .tag-in { background: #dcfce7; color: #166534; }
        .tag-out { background: #fee2e2; color: #991b1b; }

        /* æœå°‹æ¡†ç½®é ‚ */
        .sticky-search { position: sticky; top: 0; background: var(--bg); padding-bottom: 10px; z-index: 5; }
    </style>
</head>
<body>

<div class="app-wrapper">
    <header>
        <h1>ğŸ“¦ åº«å­˜ç®¡ç†ç³»çµ±</h1>
        <div id="status-light" class="status-dot"></div>
    </header>

    <main>
        <div id="view-scan">
            <div class="card" style="padding:0; margin-bottom: 10px;">
                <div id="camera-wrapper">
                    <div id="reader"></div>
                    <div style="position:absolute; color:white; font-size:0.9rem; z-index:2; pointer-events:none; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:20px;">
                        ğŸ“· å°æº– QR Code
                    </div>
                </div>
            </div>

            <div id="scan-result" class="card result-panel">
                <div style="text-align:center; color:#94a3b8; font-family:monospace; margin-bottom:5px;" id="res-id">---</div>
                
                <input type="text" id="res-name" placeholder="é»æ­¤è¼¸å…¥å•†å“åç¨±" onchange="updateInfo()">
                
                <div class="info-row">
                    <span class="stock-label">ç›®å‰é›²ç«¯åº«å­˜</span>
                    <span class="current-stock" id="res-qty">0</span>
                </div>

                <div class="action-area">
                    <div style="text-align:left; font-size:0.85rem; color:#64748b; margin-bottom:5px;">æœ¬æ¬¡ç•°å‹•æ•¸é‡ï¼š</div>
                    <div class="qty-control">
                        <input type="number" id="op-amount" class="qty-input" value="1" min="1" inputmode="numeric">
                    </div>
                    
                    <div class="btn-row">
                        <button class="btn btn-in" onclick="handleStock(1)">
                            ï¼‹ å…¥åº« (é€²è²¨)
                        </button>
                        <button class="btn btn-out" onclick="handleStock(-1)">
                            ï¼ å‡ºåº« (ç™¼è²¨)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-list" style="display:none;">
            <div class="sticky-search">
                <input type="text" id="search-input" placeholder="ğŸ” æœå°‹å•†å“åç¨±æˆ–ç·¨è™Ÿ..." onkeyup="filterList()">
            </div>
            <div class="card" id="list-container">
                <div style="text-align:center; padding:20px; color:#94a3b8;">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div id="view-logs" style="display:none;">
            <div class="card">
                <h3 style="margin-top:0; font-size:1.1rem;">ğŸ“ è¿‘ 30 ç­†ç•°å‹•</h3>
                <div id="logs-container"></div>
            </div>
        </div>

        <div id="view-create" style="display:none;">
            <div class="card" style="text-align:center;">
                <h3>ğŸ–¨ï¸ æ¨™ç±¤è£½ä½œ</h3>
                <input type="text" id="new-code" placeholder="è¼¸å…¥ç·¨è™Ÿ (å¦‚: A-001)">
                <button class="btn btn-gen" onclick="makeQR()">ç”Ÿæˆ QR Code</button>
                <div id="qrcode" style="margin-top:20px; display:flex; justify-content:center;"></div>
            </div>
        </div>
    </main>

    <nav>
        <button class="nav-btn active" onclick="switchView('scan')">
            <span class="nav-icon">ğŸ“·</span> æƒæ
        </button>
        <button class="nav-btn" onclick="switchView('list')">
            <span class="nav-icon">ğŸ“¦</span> åº«å­˜
        </button>
        <button class="nav-btn" onclick="switchView('logs')">
            <span class="nav-icon">ğŸ“</span> ç´€éŒ„
        </button>
        <button class="nav-btn" onclick="switchView('create')">
            <span class="nav-icon">ğŸ·ï¸</span> è£½ç¢¼
        </button>
    </nav>
</div>

<script>
    // --- 1. Firebase è¨­å®š (å·²ä¿ç•™ä½ çš„è¨­å®š) ---
    const firebaseConfig = {
        apiKey: "AIzaSyAUgk7DGfnCCt1-cTAhvD2Se4YZQEoXUE8",
        authDomain: "qr-inventory-2e995.firebaseapp.com",
        projectId: "qr-inventory-2e995",
        storageBucket: "qr-inventory-2e995.firebasestorage.app",
        messagingSenderId: "1041449207118",
        appId: "1:1041449207118:web:d8c66fa15024471f0d0a1f",
        measurementId: "G-YGQYMSS6E3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // é€£ç·šç‹€æ…‹ç›£è½
    db.collection("inventory").limit(1).get().then(() => {
        document.getElementById('status-light').classList.add('online');
    }).catch(err => console.log("é€£ç·šç•°å¸¸", err));

    // --- å…¨åŸŸè®Šæ•¸ ---
    let html5QrCode;
    let currentId = null;
    let isProcessing = false;
    let allData = [];

    // --- 2. ç›¸æ©Ÿé‚è¼¯ (å¼·åˆ¶å¾Œé¡é ­) ---
    function startCamera() {
        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("reader");
        }
        
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
        };
        
        // ä½¿ç”¨ environment å¼·åˆ¶å¾Œé¡é ­
        html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
            if (currentId === decodedText) return;
            
            vibrate([50]); // æƒåˆ°çŸ­éœ‡å‹•
            currentId = decodedText;
            fetchData(decodedText);
        }).catch(err => {
            console.log("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•— (å¯èƒ½æ˜¯æ¬Šé™æˆ–é é¢åˆ‡æ›):", err);
        });
    }

    function stopCamera() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().then(() => console.log("ç›¸æ©Ÿæš«åœ")).catch(err => console.log(err));
        }
    }

    // --- 3. æƒæå¾Œè³‡æ–™è™•ç† ---
    function fetchData(id) {
        document.getElementById('scan-result').style.display = 'block';
        document.getElementById('res-id').innerText = id;
        // é‡ç½®è¼¸å…¥æ•¸é‡ç‚º 1
        document.getElementById('op-amount').value = 1;
        
        db.collection("inventory").doc(id).onSnapshot(doc => {
            if (doc.exists) {
                const d = doc.data();
                document.getElementById('res-qty').innerText = d.qty;
                document.getElementById('res-name').value = d.name || "";
            } else {
                document.getElementById('res-qty').innerText = 0;
                document.getElementById('res-name').value = "";
                document.getElementById('res-name').placeholder = "æ–°å•†å“ - è«‹è¼¸å…¥åç¨±";
            }
        });
    }

    // --- 4. æ ¸å¿ƒï¼šæ‰‹å‹•è¼¸å…¥æ•¸é‡çš„åº«å­˜æ›´æ–° ---
    function handleStock(direction) {
        if (!currentId || isProcessing) return;
        
        // å–å¾—ä½¿ç”¨è€…è¼¸å…¥çš„æ•¸é‡
        const inputAmount = parseInt(document.getElementById('op-amount').value);
        if (isNaN(inputAmount) || inputAmount <= 0) {
            alert("è«‹è¼¸å…¥æ­£ç¢ºçš„æ•¸é‡");
            return;
        }

        vibrate([30]); // æŒ‰éµå›é¥‹
        isProcessing = true;
        
        // è¨ˆç®—å¯¦éš›è®Šå‹•å€¼ (æ–¹å‘ * æ•¸é‡)
        const changeValue = inputAmount * direction; 

        const docRef = db.collection("inventory").doc(currentId);
        const batch = db.batch();
        const name = document.getElementById('res-name').value || "æœªå‘½å";

        docRef.get().then(doc => {
            if (!doc.exists) {
                batch.set(docRef, { 
                    qty: changeValue > 0 ? changeValue : 0, 
                    name: name, id: currentId, updatedAt: new Date() 
                });
            } else {
                batch.update(docRef, { 
                    qty: firebase.firestore.FieldValue.increment(changeValue), 
                    name: name, updatedAt: new Date() 
                });
            }

            // å¯«å…¥ç´€éŒ„
            const logRef = db.collection("logs").doc();
            batch.set(logRef, {
                productId: currentId, productName: name,
                action: direction > 0 ? "å…¥åº«" : "å‡ºåº«",
                amount: inputAmount, // é€™è£¡è¨˜éŒ„çµ•å°å€¼
                timestamp: new Date()
            });

            return batch.commit();
        }).then(() => {
            vibrate([50, 50, 50]); // æˆåŠŸä¸‰çŸ­éœ‡
            // æˆåŠŸå¾Œå°‡æ•¸é‡é‡ç½®å› 1ï¼Œæ–¹ä¾¿ä¸‹æ¬¡æ“ä½œ
            document.getElementById('op-amount').value = 1;
        }).catch(err => alert("éŒ¯èª¤: " + err.message))
          .finally(() => isProcessing = false);
    }

    function updateInfo() {
        if(currentId) db.collection("inventory").doc(currentId).set({ name: document.getElementById('res-name').value, id: currentId }, { merge: true });
    }

    // --- 5. åˆ—è¡¨èˆ‡ç´€éŒ„ (è‡ªå‹•åŒæ­¥) ---
    db.collection("inventory").onSnapshot(snap => {
        allData = [];
        snap.forEach(doc => allData.push({ ...doc.data(), id: doc.id }));
        renderList(allData);
    });

    function renderList(data) {
        const container = document.getElementById('list-container');
        if(data.length === 0) return container.innerHTML = "<div style='text-align:center;color:#ccc'>å°šç„¡åº«å­˜è³‡æ–™</div>";
        
        container.innerHTML = data.map(item => `
            <div class="list-item">
                <div>
                    <div style="font-weight:600; font-size:1rem;">${item.name || "æœªå‘½å"}</div>
                    <div style="font-size:0.8rem; color:#94a3b8; font-family:monospace;">${item.id}</div>
                </div>
                <div style="font-size:1.2rem; font-weight:800; color:${item.qty < 5 ? 'var(--danger)' : 'var(--primary)'}">${item.qty}</div>
            </div>
        `).join('');
    }

    function filterList() {
        const key = document.getElementById('search-input').value.toLowerCase();
        renderList(allData.filter(i => (i.id+i.name).toLowerCase().includes(key)));
    }

    db.collection("logs").orderBy("timestamp", "desc").limit(30).onSnapshot(snap => {
        const container = document.getElementById('logs-container');
        container.innerHTML = snap.docs.map(doc => {
            const d = doc.data();
            const time = d.timestamp ? new Date(d.timestamp.toDate()).toLocaleTimeString([], {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}) : "--:--";
            const isIn = d.action === "å…¥åº«";
            return `
            <div class="list-item">
                <div>
                    <div style="font-weight:600">${d.productName}</div>
                    <div style="font-size:0.75rem; color:#94a3b8;">${time}</div>
                </div>
                <div style="text-align:right;">
                    <span class="tag ${isIn ? 'tag-in':'tag-out'}">${d.action} ${d.amount}</span>
                </div>
            </div>`;
        }).join('');
    });

    // --- 6. é é¢åˆ‡æ›æ§åˆ¶ ---
    function switchView(view) {
        ['scan', 'list', 'logs', 'create'].forEach(v => {
            document.getElementById('view-' + v).style.display = (v === view) ? 'block' : 'none';
        });
        
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        event.currentTarget.classList.add('active');

        // åˆ‡æ›é é¢æ™‚æ§åˆ¶ç›¸æ©Ÿé–‹é—œä»¥çœé›»
        if (view === 'scan') {
            setTimeout(startCamera, 300);
        } else {
            stopCamera();
        }
    }

    function makeQR() {
        const text = document.getElementById('new-code').value;
        if(!text) return;
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById('qrcode'), { text: text, width: 128, height: 128 });
    }

    function vibrate(pattern) {
        if (navigator.vibrate) navigator.vibrate(pattern);
    }

    // å•Ÿå‹•
    startCamera();

</script>
</body>
</html>
