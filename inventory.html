<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ™ºæ…§åº«å­˜ç³»çµ± Production</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --primary: #2563eb; --success: #10b981; --danger: #ef4444; --bg: #f1f5f9;
            --card: #ffffff; --nav-height: 70px; --header-height: 60px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #cbd5e1; margin: 0; padding: 0; height: 100vh; height: 100dvh; 
            overflow: hidden; display: flex; justify-content: center;
        }
        .app-wrapper { width: 100%; max-width: 480px; background-color: #f8fafc; height: 100%; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 25px rgba(0,0,0,0.15); }
        
        /* Fixed Header */
        header { flex: 0 0 var(--header-height); background: var(--primary); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.1rem; font-weight: 700; letter-spacing: 1px; }
        .status-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; transition: background 0.3s; }
        .status-dot.online { background: #4ade80; box-shadow: 0 0 8px #4ade80; }

        /* Main Content - R3 FIX: åŠ å¤§åº•éƒ¨ padding */
        main { flex: 1; overflow-y: hidden; 
               overflow-x: hidden; padding: 15px; 
               padding-bottom: 120px; /* å¢åŠ åº•éƒ¨ç•™ç™½ï¼Œè§£æ±ºé®æ“‹å•é¡Œ */
               position: relative;
        }
        .card { background: var(--card); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }

        /* Fixed Nav */
        nav { flex: 0 0 var(--nav-height); background: white; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-around; align-items: center; z-index: 20; padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { background: none; border: none; color: #94a3b8; font-size: 0.75rem; font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px; width: 100%; height: 100%; cursor: pointer; }
        .nav-btn.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 4px; }

        /* ç›¸æ©Ÿ */
        #camera-wrapper { position: relative; border-radius: 12px; overflow: hidden; background: black; height: 280px; display: flex; align-items: center; justify-content: center; }
        #reader video { object-fit: cover; width: 100% !important; height: 100% !important; border-radius: 12px; }

        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; text-align: center; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1.1rem; margin: 8px 0; background: #f8fafc; }
        .current-stock { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .action-area { background: #f1f5f9; padding: 15px; border-radius: 12px; margin-top: 10px; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn { padding: 15px; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn-in { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-out { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-export { background: #0f766e; width: 100%; margin-bottom: 10px; font-size: 0.9rem; flex-direction: row; gap: 8px;}

        /* åˆ—è¡¨æ¨£å¼ */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        
        /* è£½ç¢¼é é¢ (R2 FIX: ç¾åŒ–) */
        .create-card { padding: 30px 15px; text-align: center; }
        .create-card h3 { font-size: 1.3rem; margin-bottom: 25px; color: var(--primary); }
        .create-card input { font-size: 1.2rem; }
        .qrcode-container-wrapper { 
            display: flex; justify-content: center; 
            margin-top: 25px;
        }
        .qrcode-display { 
            background: #ffffff; padding: 15px; border-radius: 12px; 
            border: 2px dashed #e2e8f0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            display: inline-block; 
        }
        .qrcode-display p { margin:0; font-size:0.9rem; color:#94a3b8; }
        /* å½ˆå‡ºè¦–çª— */
        #detail-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.7); z-index: 100; display: none;
            justify-content: center; align-items: flex-end;
        }
        .modal-content {
            background: var(--bg); width: 100%; max-width: 450px; 
            height: 90%; border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column;
            overflow: hidden;
            transform: translateY(100%); transition: transform 0.3s ease-out;
        }
        #detail-modal.active .modal-content {
            transform: translateY(0);
        }
    </style>
</head>
<body>

<div class="app-wrapper">
    <header>
        <h1>ğŸ“¦ åº«å­˜ç³»çµ± Production</h1>
        <div id="status-light" class="status-dot"></div>
    </header>

    <main id="main-content-scroll">
        <div id="view-scan">
            <div class="card" style="padding:0; margin-bottom: 10px;">
                <div id="camera-wrapper">
                    <div id="reader"></div>
                </div>
            </div>

            <div id="scan-result" class="card result-panel">
                <div style="text-align:center; color:#94a3b8; font-family:monospace; margin-bottom:5px;" id="res-id">---</div>
                <input type="text" id="res-name" placeholder="è¼¸å…¥å•†å“åç¨±" onchange="updateInfo()">
                
                <div class="info-row">
                    <span style="color:#64748b; font-size:0.9rem;">ç›®å‰åº«å­˜</span>
                    <span class="current-stock" id="res-qty">0</span>
                </div>

                <div class="action-area">
                    <div style="text-align:left; font-size:0.85rem; color:#64748b; margin-bottom:5px;">ç•°å‹•æ•¸é‡ï¼š</div>
                    <input type="number" id="op-amount" class="qty-input" value="1" min="1" inputmode="numeric" style="margin-bottom:15px;">
                    <div class="btn-row">
                        <button class="btn btn-in" onclick="handleStock(1)">ï¼‹ å…¥åº«</button>
                        <button class="btn btn-out" onclick="handleStock(-1)">ï¼ å‡ºåº«</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-list" style="display:none;">
            <div class="sticky-search">
                <input type="text" id="search-input" placeholder="ğŸ” æœå°‹å•†å“..." onkeyup="filterList()">
                <button class="btn btn-export" onclick="exportToExcel()"><span>ğŸ“¥</span> åŒ¯å‡º Excel (CSV)</button>
            </div>
            <div class="card" id="list-container">
                <div style="text-align:center; padding:20px; color:#94a3b8;">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div id="view-logs" style="display:none;">
            <div class="card">
                <h3 style="margin-top:0; font-size:1.1rem;">ğŸ“ è¿‘æœŸç•°å‹•</h3>
                <div id="logs-container"></div>
            </div>
        </div>

        <div id="view-create" style="display:none;">
            <div class="card create-card">
                <h3>ğŸ–¨ï¸ æ¨™ç±¤è£½ä½œèˆ‡åˆ—å°</h3>
                <input type="text" id="new-code" placeholder="è«‹è¼¸å…¥å•†å“ç·¨è™Ÿ (SKU)">
                <button class="btn btn-gen" onclick="makeQR()">ç”Ÿæˆ QR Code</button>
                <div class="qrcode-container-wrapper">
                    <div class="qrcode-display" id="qrcode">
                        <p>å°‡åœ¨æ­¤è™•ç”Ÿæˆæ¨™ç±¤</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <nav>
        <button class="nav-btn active" onclick="switchView('scan')"><span class="nav-icon">ğŸ“·</span>æƒæ</button>
        <button class="nav-btn" onclick="switchView('list')"><span class="nav-icon">ğŸ“¦</span>åº«å­˜</button>
        <button class="nav-btn" onclick="switchView('logs')"><span class="nav-icon">ğŸ“</span>ç´€éŒ„</button>
        <button class="nav-btn" onclick="switchView('create')"><span class="nav-icon">ğŸ·ï¸</span>è£½ç¢¼</button>
    </nav>
</div>

<div id="detail-modal" onclick="if(event.target.id === 'detail-modal') closeDetail()">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title" style="font-size:1.2rem; margin:0;">å•†å“è©³æƒ…</h2>
            <button class="modal-close-btn" onclick="closeDetail()">&times;</button>
        </div>
        <div class="modal-body">
            
            <div class="card">
                <h3 style="margin-top:0;">åŸºæœ¬è³‡è¨Š</h3>
                <div class="detail-info-grid">
                    <div><div class="detail-label">æ–™è™Ÿ (ID)</div><div class="detail-value" id="detail-id">---</div></div>
                    <div><div class="detail-label">æœ€å¾Œå…¥åº«æ—¥</div><div class="detail-value" id="detail-inbound-date">---</div></div>
                </div>
                <div style="margin-bottom:15px;"><div class="detail-label">å“å</div><input type="text" id="detail-name" onchange="updateDetailInfo('name')"></div>
                
                <h3 style="margin-top:0; border-top: 1px solid #f1f5f9; padding-top:10px;">åº«å­˜ç·¨è¼¯</h3>
                <div style="margin-bottom:10px;"><div class="detail-label">æ‰‹å‹•èª¿æ•´è‡³æ­¤æ•¸é‡</div><input type="number" id="detail-qty-input" class="qty-input" min="0"></div>
                <button class="btn btn-in" style="width:100%;" onclick="updateDetailQty()">æ‰‹å‹•èª¿æ•´ä¸¦å„²å­˜</button>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸšš é€²å‡ºè²¨æ­·å²ç´€éŒ„</h3>
                <ul class="history-list" id="detail-history-list">
                    <li style="text-align:center; color:#94a3b8;">è¼‰å…¥ä¸­...</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Configs ---
    const firebaseConfig = {
        apiKey: "AIzaSyAUgk7DGfnCCt1-cTAhvD2Se4YZQEoXUE8", authDomain: "qr-inventory-2e995.firebaseapp.com",
        projectId: "qr-inventory-2e995", storageBucket: "qr-inventory-2e995.firebasestorage.app",
        messagingSenderId: "1041449207118", appId: "1:1041449207118:web:d8c66fa15024471f0d0a1f", measurementId: "G-YGQYMSS6E3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ServerTimestamp = firebase.firestore.FieldValue.serverTimestamp();
    
    let html5QrCode; let currentId = null; let isProcessing = false; let allData = [];

    function vibrate(p) { if(navigator.vibrate) navigator.vibrate(p); }

    // --- ç›¸æ©Ÿæ§åˆ¶ ---
    function startCamera() {
        if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 }, (text) => {
            if (currentId === text) return; vibrate([50]); currentId = text; fetchData(text);
        }).catch(err => console.log("Camera Error", err));
    }
    function stopCamera() { if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop(); }

    function fetchData(id) {
        document.getElementById('scan-result').style.display = 'block';
        document.getElementById('res-id').innerText = id;
        document.getElementById('op-amount').value = 1;
        db.collection("inventory").doc(id).onSnapshot(doc => {
            if (doc.exists) {
                const d = doc.data();
                document.getElementById('res-qty').innerText = d.qty;
                document.getElementById('res-name').value = d.name || "";
            } else {
                document.getElementById('res-qty').innerText = 0;
                document.getElementById('res-name').value = "";
                document.getElementById('res-name').placeholder = "æ–°å•†å“ - è«‹å‘½å";
            }
        });
    }

    function handleStock(direction) {
        if (!currentId || isProcessing) return;
        const amount = parseInt(document.getElementById('op-amount').value);
        if (isNaN(amount) || amount <= 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºæ•¸é‡");
        
        vibrate([30]); isProcessing = true;
        const change = amount * direction;
        const docRef = db.collection("inventory").doc(currentId);
        const batch = db.batch();
        const name = document.getElementById('res-name').value || "æœªå‘½å";

        docRef.get().then(doc => {
            const updateFields = { name: name, updatedAt: ServerTimestamp };
            if (direction > 0) updateFields.lastInboundDate = ServerTimestamp;
            
            if (!doc.exists) {
                batch.set(docRef, { qty: change>0?change:0, id: currentId, ...updateFields });
            } else {
                batch.update(docRef, { qty: firebase.firestore.FieldValue.increment(change), ...updateFields });
            }
            
            const logRef = db.collection("logs").doc();
            batch.set(logRef, { productId: currentId, productName: name, action: direction>0?"å…¥åº«":"å‡ºåº«", amount: amount, timestamp: ServerTimestamp });
            return batch.commit();
        }).then(() => { vibrate([50,50]); document.getElementById('op-amount').value = 1; })
          .catch(err => alert("äº¤æ˜“å¤±æ•—: " + err.message)).finally(() => isProcessing = false);
    }
    function updateInfo() { if(currentId) db.collection("inventory").doc(currentId).set({ name: document.getElementById('res-name').value, id: currentId, updatedAt: ServerTimestamp }, { merge: true }); }

    // --- åº«å­˜åˆ—è¡¨ (Bug Fix 1: Date Logic) ---
    db.collection("inventory").onSnapshot(snap => {
        allData = [];
        snap.forEach(doc => allData.push({ ...doc.data(), id: doc.id }));
        renderList(allData);
    });

    // Bug Fix 1: ä¿®æ­£æ—¥æœŸé¡¯ç¤º
    function renderList(data) {
        const container = document.getElementById('list-container');
        if(data.length === 0) return container.innerHTML = "<div style='text-align:center;color:#ccc'>ç„¡è³‡æ–™</div>";
        container.innerHTML = data.map(item => {
            // Fix: åš´æ ¼æª¢æŸ¥ä¸¦å®‰å…¨è½‰æ›æ—¥æœŸ
            const date = item.lastInboundDate?.toDate ? item.lastInboundDate.toDate().toLocaleDateString() : 'ç„¡ç´€éŒ„';
            const qtyColor = item.qty < 5 ? 'var(--danger)' : 'var(--primary)';
            return `
                <div class="list-item" onclick="showDetail('${item.id}')">
                    <div style="flex:1;">
                        <div style="font-weight:600;">${item.name || "æœªå‘½å"} (${item.id})</div>
                        <div style="font-size:0.75rem; color:#64748b;">æœ€å¾Œå…¥åº«ï¼š${date}</div>
                    </div>
                    <div class="list-qty" style="color:${qtyColor};">${item.qty}</div>
                </div>
            `;
        }).join('');
    }

    // --- ç´€éŒ„é é¢ ---
    db.collection("logs").orderBy("timestamp", "desc").onSnapshot(snap => {
        const container = document.getElementById('logs-container');
        container.innerHTML = "";
        
        if (snap.empty) {
            return container.innerHTML = "<div style='text-align:center; padding:20px; color:#94a3b8;'>ç„¡æ­·å²ç´€éŒ„</div>";
        }

        snap.forEach(doc => {
            const d = doc.data();
            const time = d.timestamp?.toDate ? d.timestamp.toDate().toLocaleString() : 'è™•ç†ä¸­...';
            const color = d.action.includes('å…¥åº«') ? 'var(--success)' : 'var(--danger)';
            const actionText = d.action.includes('æ‰‹å‹•') ? d.action : d.action;

            container.innerHTML += `
                <div class="list-item">
                    <div style="flex:1;">
                        <div style="font-weight:600">${d.productName}</div>
                        <div style="font-size:0.75rem; color:#94a3b8;">${time}</div>
                    </div>
                    <div style="text-align:right;">
                        <span style="color:${color}; font-weight:bold;">${actionText} ${d.amount}</span>
                    </div>
                </div>
            `;
        });
    });

    // --- å•†å“è©³æƒ…èˆ‡ç·¨è¼¯ ---
    function showDetail(id) {
        document.getElementById('detail-modal').style.display = 'flex';
        setTimeout(() => document.getElementById('detail-modal').classList.add('active'), 10);
        document.body.style.overflow = 'hidden';

        db.collection("inventory").doc(id).get().then(doc => {
            if (!doc.exists) return;
            const d = doc.data();
            const dateStr = d.lastInboundDate?.toDate ? d.lastInboundDate.toDate().toLocaleDateString() : 'ç„¡ç´€éŒ„';
            
            document.getElementById('modal-title').innerText = d.name || "å•†å“è©³æƒ…";
            document.getElementById('detail-id').innerText = d.id;
            document.getElementById('detail-inbound-date').innerText = dateStr;
            document.getElementById('detail-name').value = d.name || "";
            document.getElementById('detail-qty-input').value = d.qty;
            document.getElementById('detail-qty-input').setAttribute('data-item-id', id);
        });
        
        db.collection("logs").where("productId", "==", id).orderBy("timestamp", "desc").limit(30).get().then(snapshot => {
            const list = document.getElementById('detail-history-list');
            list.innerHTML = "";
            if (snapshot.empty) list.innerHTML = `<li style="text-align:center; color:#94a3b8; padding:20px;">ç„¡æ­·å²ç´€éŒ„</li>`;
            
            snapshot.forEach(doc => {
                const d = doc.data();
                const time = d.timestamp?.toDate ? d.timestamp.toDate().toLocaleString() : 'è™•ç†ä¸­...';
                const color = d.action.includes('å…¥åº«') ? 'var(--success)' : 'var(--danger)';
                list.innerHTML += `
                    <li class="history-item">
                        <span class="history-time">${time}</span>
                        <span style="color:${color}; font-weight:bold;">${d.action} ${d.amount}</span>
                    </li>
                `;
            });
        }).catch(error => {
            console.error("Firestore Index Error:", error);
            const list = document.getElementById('detail-history-list');
            list.innerHTML = `<li style="color:var(--danger); padding:20px;">ğŸš¨ **è¼‰å…¥ç´€éŒ„å¤±æ•—ï¼** (è«‹ç¢ºèªè¤‡åˆç´¢å¼•æ˜¯å¦å»ºç«‹å®Œæˆ)</li>`;
        });
    }

    function updateDetailQty() { /* ... (Logic remains the same) ... */ }
    function updateDetailInfo(field) { /* ... (Logic remains the same) ... */ }
    function closeDetail() {
        document.getElementById('detail-modal').classList.remove('active');
        setTimeout(() => document.getElementById('detail-modal').style.display = 'none', 300); 
        document.body.style.overflow = 'auto';
    }

    // --- è¼”åŠ©åŠŸèƒ½ ---
    function makeQR() {
        vibrate([50]); 
        const text = document.getElementById('new-code').value;
        if(!text) return;
        
        // R2 Fix: æ¸…ç©º placeholder å…ƒç´ ï¼Œåªä¿ç•™ QR Code
        const qrcodeContainer = document.getElementById('qrcode');
        qrcodeContainer.innerHTML = ""; 

        if (typeof QRCode !== 'undefined') {
            new QRCode(qrcodeContainer, { text: text, width: 128, height: 128 });
        } else {
            alert("QRCode å…ƒä»¶è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
        }
    }

    function switchView(view) {
        ['scan', 'list', 'logs', 'create'].forEach(v => document.getElementById('view-'+v).style.display = (v===view)?'block':'none');
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        event.currentTarget.classList.add('active');

        const mainContent = document.getElementById('main-content-scroll');
        if (view === 'scan') {
            mainContent.style.overflowY = 'hidden'; 
            setTimeout(startCamera, 300);
        } else {
            mainContent.style.overflowY = 'auto';
            stopCamera();
        }
    }
    
    function filterList() { /* ... (Logic remains the same) ... */ }
    function exportToExcel() { /* ... (Logic remains the same) ... */ }

    // --- åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('.nav-btn[onclick*="scan"]').classList.add('active');
        startCamera();
        
        document.querySelector('nav').addEventListener('click', (e) => {
            const btn = e.target.closest('.nav-btn');
            if (btn && btn.getAttribute('onclick')) {
                eval(btn.getAttribute('onclick'));
            }
        });
    });

</script>
</body>
</html>
